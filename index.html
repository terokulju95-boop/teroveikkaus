<!DOCTYPE html>
<html lang="fi">
<head>
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>üèí Turnausveikkaus ‚Äì Mobiili v4.5 (j√§√§hysyy pudotusvalikko)</title>
  <style>
    :root { --bg:#f7f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#f97316; --primary-hover:#ea580c; --border:#e5e7eb; --ok:#22c55e; --dark:#111827; }
    *{ box-sizing:border-box } html,body{ margin:0; padding:0 }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif; line-height:1.5; padding:12px }
    @media (prefers-color-scheme: dark) {
      .score-card { background:#ffffff !important; color:#000000 !important; }
      .score-card .name { color:#000000 !important; font-weight:700; }
      :root { --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --border:#334155; --primary:#f97316; --primary-hover:#ea580c; --dark:#f8fafc; }
      input, select { background:#1e293b !important; color:#ffffff !important; border-color:#475569 !important; }
      input::placeholder, select::placeholder { color:#cbd5e1 !important; opacity:1; }
      body { background: var(--bg); color: var(--text); }
      .card, .person-card, .t3-card, table th, table td { background: var(--card) !important; }
      input, select { background: #1e293b; color: var(--text); border-color: var(--border); }
      .score-card { background: var(--card); border-color: var(--border); }
      .tabs .tab { background: var(--card); color: var(--text); }
    }
    h1{ text-align:center; margin:0 0 12px; font-size:22px } h2{ margin:0 0 10px; font-size:16px }
    .layout{ max-width:960px; margin:0 auto; display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:980px){ .layout{ grid-template-columns:360px 1fr } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    @media(max-width:480px){ .row{ grid-template-columns:1fr } }
    .field{ margin-bottom:8px }
    label{ font-weight:600; font-size:14px; display:block; margin-bottom:6px }
    input[type="text"], input[type="number"], select{ width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fff }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .btn{ display:inline-flex; justify-content:center; align-items:center; gap:8px; border:none; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; background:var(--primary); color:#fff }
    .btn.small{ padding:10px } .btn:disabled{ opacity:.6; cursor:not-allowed } .btn:hover{ background:var(--primary-hover) }
    .muted{ color:var(--muted); font-size:13px } .grid{ display:grid; gap:10px } .separator{ height:1px; background:var(--border); margin:12px 0 }
    .score-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px }
    .score-card{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center }
    .score-card .name{ font-weight:700; font-size:14px } .score-card .pts{ font-size:13px; color:#111 }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    th,td{ border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; text-align:left; vertical-align:top; background:#fff }
    th:first-child,td:first-child{ border-left:1px solid var(--border) } tr:first-child th{ border-top:1px solid var(--border) }
    table input[type="text"], table input[type="number"], table select{ padding:8px 10px !important; font-size:14px !important; border-radius:6px !important; }
    table .score-combo input{ width:55px !important; padding:8px 10px !important; font-size:14px !important; }
    table .time-combo input{ width:55px !important; padding:8px 10px !important; font-size:14px !important; }
    .table-wrap { width:100%; overflow-x:auto; overflow-y:hidden; border-radius:10px; }
    .sticky-top{ position:sticky; top:0; z-index:5; background:#fafafa } .sticky-left{ position:sticky; left:0; z-index:4; background:#fafafa } .sticky-corner{ z-index:6 }
    .correct{ background-color:#86efac !important; }
    input.correct{ background-color:#86efac !important; }
    input.incorrect{ background-color:#fca5a5 !important; }
    .incorrect{ background-color:#fca5a5 !important; }
    input.correct{ background-color:#86efac !important; }
    input.incorrect{ background-color:#fca5a5 !important; } .stack{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .tabs{ display:flex; border:1px solid var(--border); border-radius:10px; overflow:hidden } .tab{ flex:1; text-align:center; padding:10px; background:#fff; cursor:pointer; font-weight:700 } .tab.active{ background:var(--dark); color:#fff }
    .person-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff } .person-title{ font-weight:800; margin-bottom:8px }
    .kv{ display:grid; grid-template-columns:1fr; gap:6px }
    .kv-row{ display:grid; grid-template-columns:180px 1fr; gap:8px; align-items:center }
    @media(max-width:420px){ .kv-row{ grid-template-columns:140px 1fr } }
    .kv-label{ font-weight:600 }
    .kv-row.correct input, .kv-row.correct select{ background:#86efac !important; }
    .score-combo{ display:flex; align-items:center; gap:6px } .score-combo input{ width:64px; text-align:center } .dash{ font-weight:800 }
    .cell-input{ width:140px; max-width:140px; padding:10px 12px; font-size:16px }
    @media(max-width:600px){ .cell-input{ width:120px; max-width:120px } }
    @media(max-width:420px){ .cell-input{ width:100px; max-width:100px } }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fafafa; font-size:12px }
    .t3-grid { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width:640px){ .t3-grid { grid-template-columns: 1fr 1fr; } }
    .t3-card { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .t3-title { font-weight:800; margin-bottom:8px; font-size:15px; }
    .t3-row { display:grid; grid-template-columns: 1fr; gap:8px; align-items:center; margin-bottom:6px; }
    .t3-dot { display:none !important; }
    .time-combo { display:flex; align-items:center; gap:6px; }
    .time-combo input { width:64px; text-align:center; }
    .colon { font-weight:800; }
    .pts-badge { display:inline-block; background:#111827; color:#fff; font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px; }
    .card-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .kv-row.correct { background-color:#86efac !important; }
    .kv-row.incorrect { background-color:#fca5a5 !important; }
    .kv-row.correct input, .kv-row.correct select { background-color:#86efac !important; color:#000 !important; }
    .kv-row.incorrect input, .kv-row.incorrect select { background-color:#fca5a5 !important; color:#000 !important; }
    table td.correct { background-color:#86efac !important; }
    table td.incorrect { background-color:#fca5a5 !important; }
    input.correct, select.correct { background-color:#86efac !important; color:#000 !important; }
    input.incorrect, select.incorrect { background-color:#fca5a5 !important; color:#000 !important; }
    .tabs .tab { color: var(--text) !important; }
    .tabs .tab.active { background:#1e293b !important; color:#fff !important; }
    .kv-row.correct .kv-label,
    .kv-row.incorrect .kv-label { color: #000 !important; }
    .table-wrap table { min-width:1000px; width:max-content; }
    .actuals-card.person-card { padding:14px; }
    .actuals-card .kv-row { grid-template-columns: 200px 1fr; }
    @media(max-width:480px){ .actuals-card .kv-row { grid-template-columns: 150px 1fr; } }
    .actuals-card input, .actuals-card select {
      padding:14px 16px;
      font-size:18px;
      border-radius:12px;
    }
    /* Lukittu tila */
    body.tournament-finished input,
    body.tournament-finished select,
    body.tournament-finished textarea {
      pointer-events: none;
      opacity: 0.7;
    }
    body.tournament-finished button:not(#exportBtn):not(#importBtn):not(#resetBtn):not(#screenshotTableBtn):not(#toggleTop3):not(#tournamentSelect):not(#downloadPdfBtn) {
      pointer-events: none;
      opacity: 0.4;
    }
    body.tournament-finished #exportBtn,
    body.tournament-finished #importBtn,
    body.tournament-finished #resetBtn,
    body.tournament-finished #screenshotTableBtn,
    body.tournament-finished #toggleTop3,
    body.tournament-finished #downloadPdfBtn {
      pointer-events: auto;
      opacity: 1;
    }
    body.tournament-finished #tournamentSelect {
      pointer-events: auto;
      opacity: 1;
    }
  </style>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
</head>
<body>
  <h1>üèí Turnausveikkaus</h1>
  <div class="layout">
    <div class="card">
      <h2>Turnaus</h2>
      <div class="field">
        <label>Valitse turnaus</label>
        <select id="tournamentSelect"></select>
      </div>
      <div class="field">
          <label>Luo uusi turnaus</label>
          <input id="newTournamentName" type="text" placeholder="Esim. MM 2025" />
      </div>
      <div class="field">
          <button id="createTournament" class="btn small" style="width:100%">Luo turnaus</button>
      </div>
      <div class="field" id="finishTournamentArea" style="display:none">
          <button id="finishTournament" class="btn small" style="width:100%;background:#dc2626">üèÅ P√§√§t√§ turnaus</button>
          <p class="muted" style="margin-top:4px;font-size:12px">Turnaus lukitaan ‚Äì muutoksia ei voi en√§√§ tehd√§.</p>
      </div>
      <div class="field" id="tournamentFinishedBadge" style="display:none">
          <div style="background:#22c55e;color:#fff;border-radius:10px;padding:10px;text-align:center;font-weight:700">‚úÖ Turnaus p√§√§ttyy</div>
      </div>
      <div class="separator"></div>
      <h2>Ottelut</h2>
      <div class="field">
        <label>Valitse ottelu</label>
        <select id="matchSelect"></select>
      </div>
      <div class="field">
        <label>Luo uusi ottelu</label>
        <input id="newMatchName" type="text" placeholder="Suomi vs " />
        <span class="muted">Vinkki: nimi alkaa valmiiksi "Suomi vs " ‚Äì lis√§√§ vastustaja.</span>
      </div>
      <div class="field">
        <button id="createMatch" class="btn small" style="width:100%">Luo ottelu</button>
      </div>
      <div class="separator"></div>
      <div class="stack" style="justify-content:space-between;align-items:center"><h2 style="margin:0">Kolmen k√§rki ‚Äì veikkaukset</h2><button id="toggleTop3" class="btn small" style="background:#fff;color:#111;border:1px solid var(--border)">Piilota</button></div>
      <div id="topThreeArea"></div>
      <div class="stack" style="margin-top:8px">
        <button id="saveTopThree" class="btn small">Tallenna veikkaukset</button>
      </div>
      <div class="separator"></div>
      <h2>Data</h2>
      <div class="stack">
        <button id="exportBtn" class="btn small" style="background:#fff;color:#111;border:1px solid var(--border)">Vie JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="btn small" style="background:#fff;color:#111;border:1px solid var(--border)">Tuo JSON</button>
        <button id="resetBtn" class="btn small" style="background:#111827">Tyhjenn√§ kaikki</button>
        <button id="screenshotTableBtn" class="btn small" style="background:#22c55e">Ota kuva (taulukko)</button>
        <button id="downloadPdfBtn" class="btn small" style="background:#7c3aed">üìÑ Lataa PDF-raportti</button>
      </div>
      <p class="muted" style="margin-top:6px">Tiedot tallentuvat t√§h√§n laitteeseen (localStorage).</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Yhteispisteet</h2>
        <div id="scoreboard"></div>
      </div>

      <div class="card" id="statsCard" style="display:none">
        <h2>üèÜ Turnauksen tilastot</h2>
        <div id="statsArea"></div>
      </div>

      <div class="card">
        <div class="stack" style="justify-content:space-between">
          <h2>Ottelun veikkaukset</h2>
          <div class="tabs">
            <div id="tabTable" class="tab">Taulukko</div>
            <div id="tabCards" class="tab">Kortit</div>
          </div>
        </div>
        <p class="muted">Taulukko: pelaajat ylh√§√§ll√§. Kortit: yksi pelaaja / kortti.</p>
        <div id="predictionsArea"></div>
      </div>

      <div class="card">
        <h2>Ottelun tulos (faktat)</h2>
        <div id="actualsArea"></div>
        <div style="margin-top:10px;display:flex;justify-content:flex-end">
          <button id="refreshCheck" class="btn small">P√§ivit√§ & tarkasta</button>
        </div>
      </div>
    </div>
  </div>

<script>
const PLAYERS = ["Roosa","Timo","Tero","Tiina","Tepa","√Ñiti","Isk√§"];

const PENALTY_REASONS = [
  'Koukkaaminen',
  'Mailasta kiinnipit√§minen',
  'Est√§minen',
  'P√§√§h√§n kohdistuva taklaus',
  'Huitominen',
  'V√§kivaltaisuus',
  'Rynt√§ys',
  'Tappelu',
  'Liian monta pelaajaa j√§√§ll√§',
  'Poikittainen maila',
  'Kampitus',
  'Kiinnipit√§minen',
  'Mailan tai esineen heitt√§minen',
  'Laitataklaus',
  'Sukeltaminen',
  'Kyyn√§rp√§√§taklaus',
  'Pelin viivytt√§minen',
  'Kiekon sulkeminen',
  'Korkea maila',
  'Sel√§st√§ taklaaminen',
  'K√§yt√∂srangaistus',
  'P√§√§ll√§ iskeminen',
  'Polvitaklaus',
  'Mailan p√§√§ll√§ ly√∂minen tai sen yritys',
  'Keih√§st√§minen',
  'Jalkapyyhk√§isy',
  'Rikkoutuneella mailalla pelaaminen',
  'V√§√§r√§ varuste',
  'Pelaajaa ei ole merkitty p√∂yt√§kirjaan',
  'Potkaisee tai sylkee',
  'Ei j√§√§hy√§'
];

const GOAL_SCORERS = [
  'Juuse Saros (MV)',
  'Joonas Korpisalo (MV)',
  'Kevin Lankinen (MV)',
  'Miro Heiskanen (P)',
  'Esa Lindell (P)',
  'Niko Mikkola (P)',
  'Henri Jokiharju (P)',
  'Rasmus Ristolainen (P)',
  'Nikolas Matinpalo (P)',
  'Olli M√§√§tt√§ (P)',
  'Mikko Lehtonen (P)',
  'Mikael Granlund (H)',
  'Roope Hintz (H)',
  'Mikko Rantanen (H)',
  'Teuvo Ter√§v√§inen (H)',
  'Sebastian Aho (H)',
  'Artturi Lehkonen (H)',
  'Eetu Luostarinen (H)',
  'Anton Lundell (H)',
  'Kaapo Kakko (H)',
  'Eeli Tolvanen (H)',
  'Erik Haula (H)',
  'Joel Armia (H)',
  'Oliver Kapanen (H)',
  'Joel Kiviranta (H)',
  'Ei maalia'
];

const PENALTY_TAKERS = [
  'Juuse Saros (MV)',
  'Joonas Korpisalo (MV)',
  'Kevin Lankinen (MV)',
  'Miro Heiskanen (P)',
  'Esa Lindell (P)',
  'Niko Mikkola (P)',
  'Henri Jokiharju (P)',
  'Rasmus Ristolainen (P)',
  'Nikolas Matinpalo (P)',
  'Olli M√§√§tt√§ (P)',
  'Mikko Lehtonen (P)',
  'Mikael Granlund (H)',
  'Roope Hintz (H)',
  'Mikko Rantanen (H)',
  'Teuvo Ter√§v√§inen (H)',
  'Sebastian Aho (H)',
  'Artturi Lehkonen (H)',
  'Eetu Luostarinen (H)',
  'Anton Lundell (H)',
  'Kaapo Kakko (H)',
  'Eeli Tolvanen (H)',
  'Erik Haula (H)',
  'Joel Armia (H)',
  'Oliver Kapanen (H)',
  'Joel Kiviranta (H)',
  'Ei j√§√§hy√§',
  'Joukkue rangaistus'
];

const FIELDS = [
  {key:'lopputulos',label:'Lopputulos'},
  {key:'ekan_maalintekija',label:'Ekan maalintekij√§'},
  {key:'ekan_maali_aika',label:'Ekan maalin tekoaika'},
  {key:'ekan_jahyn_saaja',label:'Ekan j√§√§hyn saaja'},
  {key:'ekan_jahyn_syy',label:'Ekan j√§√§hyn syy'},
  {key:'montako_jahyja',label:'Montako j√§√§hyd√§'},
  {key:'parempi_laukasu',label:'Kummalla parempi laukaus%'},
  {key:'parempi_alotus',label:'Kummalla parempi aloitus%'},
  {key:'parempi_torjunta',label:'Kummalla parempi torjunta%'},
  {key:'parempi_alivoima',label:'Kummalla parempi alivoima%'},
  {key:'parempi_ylivoima',label:'Kummalla parempi ylivoima%'},
  {key:'era1',label:'1. er√§ tulos'},
  {key:'era2',label:'2. er√§ tulos'},
  {key:'valmentaja_haasto',label:'Valmentaja haasto'},
  {key:'maali_tyhjiin',label:'Maali tyhjiin'}
];

const ONE_X_TWO_KEYS = new Set(['parempi_laukasu','parempi_alotus','parempi_torjunta','parempi_alivoima','parempi_ylivoima','era1','era2']);
const KYLLA_EI_KEYS = new Set(['valmentaja_haasto','maali_tyhjiin']);
const TEXT_KEYS = new Set([]);
const NUMBER_KEYS = new Set(['montako_jahyja']);
const PENALTY_REASON_KEY = 'ekan_jahyn_syy';
const GOAL_SCORER_KEY = 'ekan_maalintekija';
const PENALTY_TAKER_KEY = 'ekan_jahyn_saaja';

let data = JSON.parse(localStorage.getItem('turnausveikkaus_data') || '{}');
if (!data.tournaments) data.tournaments = [];
let selectedTournamentId = data.selectedTournamentId || null;
let selectedMatchId = null;
let viewMode = localStorage.getItem('tv_view') || 'cards';

function save(){ data.selectedTournamentId = selectedTournamentId; localStorage.setItem('turnausveikkaus_data', JSON.stringify(data)); }
function getTournament(){ return data.tournaments.find(t => String(t.id) === String(selectedTournamentId)); }
const $ = (id)=>document.getElementById(id);
function ciEq(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }

// Vertaa aikoja: hyv√§ksyy ¬±1 minuutti
function timeMatch(predTime, actualTime) {
  if (!predTime || !actualTime) return false;
  
  const parseTime = (str) => {
    const m = (str||'').match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    return parseInt(m[1]) * 60 + parseInt(m[2]); // sekunteiksi
  };
  
  const predSec = parseTime(predTime);
  const actualSec = parseTime(actualTime);
  
  if (predSec === null || actualSec === null) return false;
  
  // ¬±1 minuutti = ¬±60 sekuntia
  return Math.abs(predSec - actualSec) <= 60;
}

// Yleinen vertailufunktio joka k√§ytt√§√§ oikeaa logiikkaa riippuen kent√§st√§
function fieldMatch(key, predValue, actualValue) {
  if (!actualValue || actualValue === '') return false;
  if (!predValue || predValue === '') return false;
  
  if (key === 'ekan_maali_aika') {
    return timeMatch(predValue, actualValue);
  }
  
  return ciEq(predValue, actualValue);
}

function normalizeScore(a,b){ const A=(a||'').toString().trim(), B=(b||'').toString().trim(); if(A===''&&B==='') return ''; return `${A||'0'}-${B||'0'}`; }
function parseScore(str){ const m=(str||'').match(/^(\d+)\s*[-‚Äì]\s*(\d+)$/); return m?[m[1],m[2]]:['','']; }
function parseTimeParts(str){ const m=(str||'').match(/^(\d{1,2}):(\d{2})$/); return m ? [m[1].padStart(2,'0'), m[2]] : ['','']; }

function calcMatchPoints(t, matchId, player){
  const preds = (t.predictions[matchId]||{})[player] || {};
  const actual = t.actuals[matchId] || {};
  let s = 0;
  FIELDS.forEach(f=>{ 
    const pv = preds[f.key]||''; 
    const av = actual[f.key]||''; 
    if(av!=='' && fieldMatch(f.key, pv, av)) s++; 
  });
  return s;
}
function calcTotalScores(t){
  const totals={}; PLAYERS.forEach(p=> totals[p]=0);
  (t.matches||[]).forEach(m=>{
    const preds=t.predictions[m.id]||{}; const actual=t.actuals[m.id]||{};
    PLAYERS.forEach(p=>{
      let s=0; 
      FIELDS.forEach(f=>{ 
        const pred=preds[p]?.[f.key]||''; 
        const act=actual[f.key]||''; 
        if(act!=='' && fieldMatch(f.key, pred, act)) s++; 
      });
      totals[p]+=s;
    });
  });
  if (t.topThreePrediction){
    const actualTopThree = t.actualTopThree || [];
    PLAYERS.forEach(p=>{
      const pred = t.topThreePrediction[p] || [];
      if (pred.length===3){ let pts=0; pred.forEach((team,i)=>{ if(team && actualTopThree[i] && ciEq(team,actualTopThree[i])) pts+=2; }); totals[p]+=pts; }
    });
  }
  return totals;
}

function renderTournamentSelect(){
  const sel=$('tournamentSelect');
  const opts=['<option value="">Valitse turnaus‚Ä¶</option>'].concat(
    (data.tournaments||[]).map(t=>`<option value="${t.id}" ${String(t.id)===String(selectedTournamentId)?'selected':''}>${t.name}</option>`)
  );
  sel.innerHTML=opts.join('');
  sel.onchange=e=>{ selectedTournamentId=e.target.value||null; selectedMatchId=null; viewMode='cards'; localStorage.setItem('tv_view','cards'); save(); renderAll(); };
}
function renderMatchSelect(){
  const sel=$('matchSelect'), t=getTournament();
  if(!t){ sel.innerHTML='<option value="">‚Äî</option>'; sel.disabled=true; return; }
  sel.disabled=false;
  const opts=['<option value="">Valitse‚Ä¶</option>'].concat(
    (t.matches||[]).map(m=>`<option value="${m.id}" ${String(m.id)===String(selectedMatchId)?'selected':''}>${m.name}</option>`)
  );
  sel.innerHTML=opts.join('');
  sel.onchange=e=>{ selectedMatchId=e.target.value||null; viewMode='cards'; localStorage.setItem('tv_view','cards'); renderPredictions(); renderActuals(); renderScoreboard(); };
}

function renderTopThree(){
  const wrap = $('topThreeArea');
  const t = getTournament();
  if (!t){ wrap.innerHTML='<p class="muted">Luo ensin turnaus.</p>'; return; }
  t.topThreePrediction = t.topThreePrediction || {};
  t.actualTopThree = t.actualTopThree || ['','',''];

  // MAAJOUKKUELISTA - Kaikki isoilla kirjaimilla
  const NATIONAL_TEAMS = [
    'KANADA','SUOMI','USA','RUOTSI','TSEKKI','RANSKA','SVEITSI','ITALIA',
    'SLOVAKIA','TANSKA','SAKSA','LATVIA','VEN√ÑJ√Ñ','NORJA','ISO-BRITANNIA',
    'KAZAKSTAN','VALKO-VEN√ÑJ√Ñ','UNKARI','IT√ÑVALTA','SLOVENIA','PUOLA',
    'UKRAINA','JAPANI','ETEL√Ñ-KOREA','KIINA','VIRO','LIETTUA',
  ];
  const teamOptions = '<option value=""></option>' + NATIONAL_TEAMS.map(team => `<option value="${team}">${team}</option>`).join('');

  let html = '<div class="t3-grid">';
  html += `<div class="t3-card">
    <div class="t3-title">Todellinen j√§rjestys</div>
    ${[0,1,2].map(i=>`
      <div class="t3-row">
        <select data-top3-actual-card="${i}">${teamOptions}</select>
      </div>`).join('')}
  </div>`;

  html += PLAYERS.map(p=>{
    const arr = t.topThreePrediction[p] || ['','',''];
    return `<div class="t3-card">
      <div class="t3-title">${p}</div>
      ${[0,1,2].map(i=>`
        <div class="t3-row">
          <select data-top3-card="${p}:${i}">${teamOptions}</select>
        </div>`).join('')}
    </div>`;
  }).join('');

  html += '</div>';
  wrap.innerHTML = html;
  
  // Asetetaan valitut arvot
  [0,1,2].forEach(i=>{
    const sel = wrap.querySelector(`[data-top3-actual-card="${i}"]`);
    if(sel && t.actualTopThree[i]) sel.value = t.actualTopThree[i];
  });
  PLAYERS.forEach(p=>{
    const arr = t.topThreePrediction[p] || ['','',''];
    [0,1,2].forEach(i=>{
      const sel = wrap.querySelector(`[data-top3-card="${p}:${i}"]`);
      if(sel && arr[i]) sel.value = arr[i];
    });
  });
  
  function markTopThreeClasses(){
    const actual = (t.actualTopThree || []).map(x => (x||'').trim().toLowerCase());
    wrap.querySelectorAll('[data-top3-card]').forEach(inp=>{
      inp.classList.remove('correct','incorrect');
      const val = (inp.value||'').trim().toLowerCase();
      const parts = inp.dataset.top3Card.split(':');
      const idx = Number(parts[1]);
      const act = actual[idx] || '';
      if(act){
        if(val && val === act){ inp.classList.add('correct'); }
        else if(val){ inp.classList.add('incorrect'); }
      }
    });
  }
  markTopThreeClasses();
  wrap.querySelectorAll('select[data-top3-card]').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const [player, idx] = e.target.dataset.top3Card.split(':');
      t.topThreePrediction[player] = t.topThreePrediction[player] || ['','',''];
      t.topThreePrediction[player][Number(idx)] = e.target.value;
      markTopThreeClasses();
      renderScoreboard();
      save();
    });
  });
  wrap.querySelectorAll('select[data-top3-actual-card]').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const idx = Number(e.target.dataset.top3ActualCard);
      t.actualTopThree[idx] = e.target.value;
      markTopThreeClasses();
      renderScoreboard();
      save();
    });
  });
}

function renderScoreboard(){
  const el=$('scoreboard'); if(!selectedTournamentId){ el.innerHTML='<p class="muted">Valitse turnaus.</p>'; return; }
  const t=getTournament(); const totals=calcTotalScores(t); const sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const icons=['ü•á','ü•à','ü•â','üí©','üí©','üí©','üí©'];
  el.innerHTML='<div class="score-grid">'+sorted.map(([n,pts],i)=>`<div class="score-card"><div class="name">${icons[i]||''} ${n}</div><div class="pts">${pts} p</div></div>`).join('')+'</div>';
}

function widgetHTML(kind,key,value,dataset){
  const ds = kind==='pred' ? `data-pred="${dataset}"` : `data-act="${key}"`;
  if(key==='lopputulos'){
    const parts = (value||'').split('-');
    const home = parts[0] ? parts[0].trim() : '';
    const away = parts[1] ? parts[1].trim() : '';
    const homeAttr = kind==='pred' ? `data-pred-home="${dataset}"` : `data-act-home`;
    const awayAttr = kind==='pred' ? `data-pred-away="${dataset}"` : `data-act-away`;
    return `<div class="score-combo">
      <input type="number" inputmode="numeric" ${homeAttr} value="${home}" placeholder="0" />
      <span class="dash">-</span>
      <input type="number" inputmode="numeric" ${awayAttr} value="${away}" placeholder="0" />
    </div>`;
   }
  if(key==='ekan_maali_aika'){
    const parts = (value||'').split(':');
    const min = parts[0] ? parts[0].trim() : '';
    const sec = parts[1] ? parts[1].trim() : '';
    const minAttr = kind==='pred' ? `data-pred-min="${dataset}"` : `data-act-min`;
    const secAttr = kind==='pred' ? `data-pred-sec="${dataset}"` : `data-act-sec`;
    return `<div class="time-combo">
      <input type="number" inputmode="numeric" ${minAttr} value="${min}" placeholder="00" />
      <span class="colon">:</span>
      <input type="number" inputmode="numeric" ${secAttr} value="${sec}" placeholder="00" />
    </div>`;
  }
  if(key===GOAL_SCORER_KEY){
    const opts = ['', ...GOAL_SCORERS];
    return `<select ${ds}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o===''?'‚Äî':o}</option>`).join('')}</select>`;
  }
  if(key===PENALTY_TAKER_KEY){
    const opts = ['', ...PENALTY_TAKERS];
    return `<select ${ds}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o===''?'‚Äî':o}</option>`).join('')}</select>`;
  }
  if(key===PENALTY_REASON_KEY){
    const opts = ['', ...PENALTY_REASONS];
    return `<select ${ds}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o===''?'‚Äî':o}</option>`).join('')}</select>`;
  }
  if(ONE_X_TWO_KEYS.has(key)){ const opts=['','1','X','2']; return `<select ${ds}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o===''?'‚Äî':o}</option>`).join('')}</select>`; }
  if(KYLLA_EI_KEYS.has(key)){ const opts=['','Kyll√§','Ei']; return `<select ${ds}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o===''?'‚Äî':o}</option>`).join('')}</select>`; }
  if(NUMBER_KEYS.has(key)){ return `<input type="number" inputmode="numeric" ${ds} value="${value||''}" placeholder="0" />`; }
  if(TEXT_KEYS.has(key)){ return `<input type="text" inputmode="text" ${ds} value="${value||''}" placeholder="Kirjoita" />`; }
  return `<input type="text" ${ds} value="${value||''}" placeholder="‚Ä¶" />`;
}

function setCellHighlightFor(player,key){
  const t=getTournament(); if(!t||!selectedMatchId) return;
  const preds=t.predictions[selectedMatchId]||{}; const actual=(t.actuals[selectedMatchId]||{})[key]||''; const val=(preds[player]||{})[key]||'';
  const hasAct = actual!==''; const hasPred = (val||'')!==''; const eq = hasAct && fieldMatch(key, val, actual); const neq = hasAct && hasPred && !eq;
  const cell=document.querySelector(`[data-pred="${player}:${key}"]`)?.closest('td'); if(cell){ cell.classList.toggle('correct',eq); cell.classList.toggle('incorrect',neq); }
  const row=document.querySelector(`[data-card-pred="${player}:${key}"]`)?.closest('.kv-row'); if(row){ row.classList.toggle('correct',eq); row.classList.toggle('incorrect',neq); }
}
function refreshHighlightsForField(key){ PLAYERS.forEach(p=> setCellHighlightFor(p,key)); }
function refreshAllHighlights(){ FIELDS.forEach(f=> refreshHighlightsForField(f.key)); }

function renderPredictions(){
  const el=$('predictionsArea'), t=getTournament();
  if(!t){ el.innerHTML='<p class="muted">Luo ensin turnaus.</p>'; return; }
  if(!selectedMatchId){ el.innerHTML='<p class="muted">Valitse tai luo ottelu.</p>'; return; }
  t.predictions[selectedMatchId]=t.predictions[selectedMatchId]||{}; t.actuals[selectedMatchId]=t.actuals[selectedMatchId]||{};
  $('tabTable').classList.toggle('active', viewMode==='table'); $('tabCards').classList.toggle('active', viewMode==='cards');

  if(viewMode==='cards'){
    const cards=PLAYERS.map(p=>{
      const pred=t.predictions[selectedMatchId][p]||{};
      const matchPts = calcMatchPoints(t, selectedMatchId, p);
      const rows=FIELDS.map(f=>{
        const v=pred[f.key]||''; const act=(t.actuals[selectedMatchId][f.key]||''); const isCorrect=(act!=='') && fieldMatch(f.key, v, act); const isIncorrect=(act!=='') && (v!=='') && !isCorrect;
        const w=(f.key==='lopputulos')?`<div data-card-pred="${p}:${f.key}">${widgetHTML('pred',f.key,v,`${p}:${f.key}`)}</div>`:widgetHTML('pred',f.key,v,`${p}:${f.key}`);
        return `<div class="kv-row ${isCorrect?'correct':''} ${isIncorrect?'incorrect':''}"><div class="kv-label">${f.label}</div>${w}</div>`;
      }).join('');
      return `<div class="person-card"><div class="card-head"><div class="person-title">${p}</div><div class="pts-badge" title="Pisteet t√§st√§ pelist√§">${matchPts} p</div></div><div class="kv">${rows}</div></div>`;
    }).join('');
    el.innerHTML=cards;
  } else {
    const actual=t.actuals[selectedMatchId];
    let thead=`<tr><th class="sticky-top sticky-left sticky-corner">Kohde</th>${PLAYERS.map(p=>`<th class="sticky-top">${p}</th>`).join('')}</tr>`;
    let tbody=FIELDS.map(f=>{
      let row=`<tr><th class="sticky-left">${f.label}</th>`;
      row+=PLAYERS.map(p=>{
        const predVal=(t.predictions[selectedMatchId][p]||{})[f.key]||''; const isCorrect = actual[f.key] ? fieldMatch(f.key, predVal, actual[f.key]) : false;
        const hasPred = (predVal || "") !== "";
        const isIncorrect = actual[f.key] && hasPred && !isCorrect;
        let w=widgetHTML('pred',f.key,predVal,`${p}:${f.key}`); if(f.key==='lopputulos') w=`<div data-cell="${p}:${f.key}">${w}</div>`;
        return `<td class="${isCorrect?'correct':''} ${isIncorrect?'incorrect':''}">${w}</td>`;
      }).join('');
      row+='</tr>'; return row;
    }).join('');
    el.innerHTML=`<div class="table-wrap"><table><thead>${thead}</thead><tbody>${tbody}</tbody></table></div>`;
  }

  el.querySelectorAll('input[data-pred], input[data-pred-home], input[data-pred-away], input[data-pred-min], input[data-pred-sec], select[data-pred]').forEach(inp=>{
    inp.addEventListener('input',e=>{ 
      let dataset = e.target.dataset.pred;
      
      // K√§sitell√§√§n lopputulos (kaksi kentt√§√§)
      if(e.target.dataset.predHome !== undefined || e.target.dataset.predAway !== undefined){
        const parent = e.target.closest('.score-combo');
        if(parent){
          const homeInput = parent.querySelector('input[data-pred-home]');
          const awayInput = parent.querySelector('input[data-pred-away]');
          if(homeInput && awayInput && homeInput.dataset.predHome){
            const [player,key] = homeInput.dataset.predHome.split(':');
            const homeVal = homeInput.value;
            const awayVal = awayInput.value;
            t.predictions[selectedMatchId][player]=t.predictions[selectedMatchId][player]||{}; 
            t.predictions[selectedMatchId][player]['lopputulos'] = homeVal && awayVal ? `${homeVal}-${awayVal}` : '';
            setCellHighlightFor(player,'lopputulos');
            return;
          }
        }
      }
      
      // K√§sitell√§√§n ekan maalin aika (kaksi kentt√§√§)
      if(e.target.dataset.predMin !== undefined || e.target.dataset.predSec !== undefined){
        const parent = e.target.closest('.time-combo');
        if(parent){
          const minInput = parent.querySelector('input[data-pred-min]');
          const secInput = parent.querySelector('input[data-pred-sec]');
          if(minInput && secInput && minInput.dataset.predMin){
            const [player,key] = minInput.dataset.predMin.split(':');
            const minVal = minInput.value;
            const secVal = secInput.value;
            t.predictions[selectedMatchId][player]=t.predictions[selectedMatchId][player]||{}; 
            t.predictions[selectedMatchId][player]['ekan_maali_aika'] = minVal && secVal ? `${minVal}:${secVal}` : '';
            setCellHighlightFor(player,'ekan_maali_aika');
            return;
          }
        }
      }
      
      // Normaali yhden kent√§n k√§sittely
      if(dataset){
        const [player,key]=dataset.split(':'); 
        let value=e.target.value;
        t.predictions[selectedMatchId][player]=t.predictions[selectedMatchId][player]||{}; 
        t.predictions[selectedMatchId][player][key]=value; 
        setCellHighlightFor(player,key);
      }
    });
    inp.addEventListener('blur',()=>{ save(); renderScoreboard(); });
  });
}

function renderActuals(){
  const el=$('actualsArea'), t=getTournament();
  if(!t){ el.innerHTML='<p class="muted">Luo ensin turnaus.</p>'; return; }
  if(!selectedMatchId){ el.innerHTML='<p class="muted">Valitse tai luo ottelu.</p>'; return; }
  t.actuals[selectedMatchId]=t.actuals[selectedMatchId]||{}; const act=t.actuals[selectedMatchId];

  const rows = FIELDS.map(f=>{
    const w = widgetHTML('act', f.key, act[f.key]||'', f.key);
    return `<div class="kv-row"><div class="kv-label">${f.label}</div>${w}</div>`;
  }).join('');

  el.innerHTML = `<div class="person-card actuals-card">
    <div class="card-head">
      <div class="person-title">Faktat</div>
      <div class="pill">Ottelun tulos</div>
    </div>
    <div class="kv">${rows}</div>
  </div>`;

  el.querySelectorAll('input[data-act], input[data-act-home], input[data-act-away], input[data-act-min], input[data-act-sec], select[data-act]').forEach(inp=>{
    inp.addEventListener('input',e=>{
      let key = e.target.dataset.act;
      
      // K√§sitell√§√§n lopputulos (kaksi kentt√§√§)
      if(e.target.dataset.actHome !== undefined || e.target.dataset.actAway !== undefined){
        const parent = e.target.closest('.score-combo');
        if(parent){
          const homeInput = parent.querySelector('input[data-act-home]');
          const awayInput = parent.querySelector('input[data-act-away]');
          const homeVal = homeInput ? homeInput.value : '';
          const awayVal = awayInput ? awayInput.value : '';
          t.actuals[selectedMatchId]['lopputulos'] = homeVal && awayVal ? `${homeVal}-${awayVal}` : '';
          refreshHighlightsForField('lopputulos');
          renderScoreboard();
          return;
        }
      }
      
      // K√§sitell√§√§n ekan maalin aika (kaksi kentt√§√§)
      if(e.target.dataset.actMin !== undefined || e.target.dataset.actSec !== undefined){
        const parent = e.target.closest('.time-combo');
        if(parent){
          const minInput = parent.querySelector('input[data-act-min]');
          const secInput = parent.querySelector('input[data-act-sec]');
          const minVal = minInput ? minInput.value : '';
          const secVal = secInput ? secInput.value : '';
          t.actuals[selectedMatchId]['ekan_maali_aika'] = minVal && secVal ? `${minVal}:${secVal}` : '';
          refreshHighlightsForField('ekan_maali_aika');
          renderScoreboard();
          return;
        }
      }
      
      // Normaali yhden kent√§n k√§sittely
      if(key){
        t.actuals[selectedMatchId][key]=e.target.value;
        refreshHighlightsForField(key);
        renderScoreboard();
      }
    });
    inp.addEventListener('blur',()=>{ save(); renderScoreboard(); });
  });
}

function renderTournamentStatus(){
  const t = getTournament();
  const finishArea = $('finishTournamentArea');
  const badge = $('tournamentFinishedBadge');
  if(!t){
    if(finishArea) finishArea.style.display='none';
    if(badge) badge.style.display='none';
    document.body.classList.remove('tournament-finished');
    $('statsCard').style.display='none';
    return;
  }
  if(t.finished){
    if(finishArea) finishArea.style.display='none';
    if(badge) badge.style.display='';
    document.body.classList.add('tournament-finished');
    renderStats();
  } else {
    if(finishArea) finishArea.style.display='';
    if(badge) badge.style.display='none';
    document.body.classList.remove('tournament-finished');
    $('statsCard').style.display='none';
  }
}

function renderStats(){
  const t = getTournament();
  if(!t) return;
  $('statsCard').style.display='';
  const el = $('statsArea');

  // Laske yhteispisteet
  const totals = calcTotalScores(t);
  const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]);

  // Paras pisteet yhdest√§ ottelusta
  let bestMatch = null; // {player, matchName, pts}
  (t.matches||[]).forEach(m=>{
    PLAYERS.forEach(p=>{
      const pts = calcMatchPoints(t, m.id, p);
      if(!bestMatch || pts > bestMatch.pts){
        bestMatch = {player: p, matchName: m.name, pts};
      }
    });
  });

  // Jokaisen pelaajan paras peli
  const playerBests = {};
  PLAYERS.forEach(p=>{
    let best = null;
    (t.matches||[]).forEach(m=>{
      const pts = calcMatchPoints(t, m.id, p);
      if(!best || pts > best.pts) best = {matchName: m.name, pts};
    });
    playerBests[p] = best;
  });

  // Yksitt√§iset otteluvoittajat (eniten pisteit√§ per ottelu)
  const matchWinners = (t.matches||[]).map(m=>{
    let best = null;
    PLAYERS.forEach(p=>{
      const pts = calcMatchPoints(t, m.id, p);
      if(!best || pts > best.pts) best = {player:p, pts};
      else if(pts === best.pts) best.player += ' & ' + p;
    });
    return {matchName: m.name, ...best};
  });

  let html = '';

  // Voittaja podium
  html += `<div style="margin-bottom:14px">
    <div style="font-weight:700;margin-bottom:8px;font-size:15px">ü•á Lopputulokset</div>
    <div class="score-grid">
      ${sorted.map(([n,pts],i)=>{
        const medals=['ü•á','ü•à','ü•â'];
        return `<div class="score-card"><div class="name">${medals[i]||''} ${n}</div><div class="pts">${pts} p</div></div>`;
      }).join('')}
    </div>
  </div>`;

  html += '<div class="separator"></div>';

  // Paras yksitt√§inen suoritus
  if(bestMatch){
    html += `<div style="margin-bottom:14px">
      <div style="font-weight:700;margin-bottom:6px;font-size:15px">‚≠ê Paras suoritus yhdest√§ ottelusta</div>
      <div style="background:var(--card);border:2px solid var(--primary);border-radius:10px;padding:10px">
        <div style="font-size:18px;font-weight:800">${bestMatch.player}</div>
        <div style="color:var(--muted);font-size:14px">${bestMatch.matchName}</div>
        <div style="font-size:24px;font-weight:800;color:var(--primary)">${bestMatch.pts} p</div>
      </div>
    </div>`;
    html += '<div class="separator"></div>';
  }

  // Jokaisen pelaajan paras ottelu
  html += `<div style="margin-bottom:14px">
    <div style="font-weight:700;margin-bottom:8px;font-size:15px">üéØ Jokaisen pelaajan paras ottelu</div>
    <div class="score-grid">
      ${PLAYERS.map(p=>{
        const b = playerBests[p];
        return `<div class="score-card">
          <div class="name">${p}</div>
          <div class="pts">${b ? b.pts + ' p' : '‚Äî'}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">${b ? b.matchName : ''}</div>
        </div>`;
      }).join('')}
    </div>
  </div>`;

  html += '<div class="separator"></div>';

  // Ottelukohtaiset voittajat
  if(matchWinners.length > 0){
    html += `<div style="margin-bottom:6px">
      <div style="font-weight:700;margin-bottom:8px;font-size:15px">üèÖ Ottelujen voittajat</div>
      <div style="display:grid;gap:6px">
        ${matchWinners.map(w=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--card);border:1px solid var(--border);border-radius:8px">
            <div style="font-size:13px;color:var(--muted)">${w.matchName}</div>
            <div><span style="font-weight:700">${w.player}</span> <span class="pts-badge">${w.pts} p</span></div>
          </div>`).join('')}
      </div>
    </div>`;
  }

  el.innerHTML = html;
}

document.getElementById('finishTournament').onclick = ()=>{
  const t = getTournament();
  if(!t) return;
  if(!confirm(`Haluatko varmasti p√§√§tt√§√§ turnauksen "${t.name}"?\n\nTurnaus lukitaan eik√§ sit√§ voi en√§√§ muokata.`)) return;
  t.finished = true;
  save();
  renderAll();
  renderTournamentStatus();
};

document.getElementById('createTournament').onclick=()=>{
  const name=$('newTournamentName').value.trim();
  if(!name){ alert('Anna turnauksen nimi'); return; }
  const id=Date.now().toString();
  data.tournaments.push({ id, name, matches:[], predictions:{}, actuals:{}, topThreePrediction:{}, actualTopThree:[] });
  selectedTournamentId=id; save(); renderAll(); $('newTournamentName').value='';
};
document.getElementById('createMatch').onclick=()=>{
  const t=getTournament(); if(!t){ alert('Luo ensin turnaus'); return; }
  let name=$('newMatchName').value.trim(); if(name==='') name='Suomi vs ';
  const id=Date.now().toString();
  t.matches.push({ id, name }); selectedMatchId=id; viewMode='cards'; localStorage.setItem('tv_view','cards'); save(); renderAll(); $('newMatchName').value='Suomi vs ';
};

$('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='turnausveikkaus_data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); };
$('importBtn').onclick=()=>{ $('importFile').click(); };
$('importFile').addEventListener('change',e=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(!obj||typeof obj!=='object') throw new Error('Virheellinen JSON'); data=obj; selectedTournamentId=data.selectedTournamentId||null; selectedMatchId=null; save(); renderAll(); alert('Data tuotu.'); }catch(err){ alert('Tuonti ep√§onnistui: '+err.message); } }; reader.readAsText(file,'utf-8'); });
$('resetBtn').onclick=()=>{ if(!confirm('Tyhjennet√§√§nk√É√∂ kaikki data t√§lt√§ laitteelta?')) return; data={ tournaments:[], selectedTournamentId:null }; selectedTournamentId=null; selectedMatchId=null; save(); renderAll(); };

let top3Visible = localStorage.getItem('tv_top3_visible');
if (top3Visible === null) top3Visible = '1';

function applyTop3Visibility(){
  const area = document.getElementById('topThreeArea');
  const saveBtn = document.getElementById('saveTopThree');
  const saveRow = saveBtn ? saveBtn.closest('.stack') : null;
  const btn = document.getElementById('toggleTop3');
  const show = top3Visible === '1';
  if(area) area.style.display = show ? '' : 'none';
  if(saveRow) saveRow.style.display = show ? '' : 'none';
  if(btn) btn.textContent = show ? 'Piilota' : 'N√§yt√§';
}

document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('toggleTop3');
  if(btn){
    btn.addEventListener('click', ()=>{
      top3Visible = (top3Visible === '1') ? '0' : '1';
      localStorage.setItem('tv_top3_visible', top3Visible);
      applyTop3Visibility();
    });
  }
  applyTop3Visibility();
});

$('tabTable').onclick=()=>{ viewMode='table'; localStorage.setItem('tv_view','table'); renderPredictions(); };
$('tabCards').onclick=()=>{ viewMode='cards'; localStorage.setItem('tv_view','cards'); renderPredictions(); };

document.getElementById('refreshCheck').addEventListener('click', ()=>{
  save(); renderScoreboard(); refreshAllHighlights();
});

function renderAll(){ renderTournamentSelect(); renderMatchSelect(); renderTopThree(); renderScoreboard(); renderPredictions(); renderActuals(); renderTournamentStatus(); }
function isFinished(){ const t=getTournament(); return t && t.finished; }
(data.tournaments||[]).forEach(t=>{ t.matches=(t.matches||[]).map(m=>({...m, id:String(m.id)})); });
$('newMatchName').value='Suomi vs ';
renderAll();
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js");
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  const btn = document.getElementById('screenshotTableBtn');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    try{
      const prev = window.viewMode || 'cards';
      window.viewMode = 'table';
      localStorage.setItem('tv_view','table');
      if (typeof window.renderPredictions === 'function') window.renderPredictions();
      await new Promise(r=>setTimeout(r, 100));
      const area = document.getElementById('predictionsArea');
      const target = area.querySelector('.table-wrap') || area;
      const opts = { scale: 3, backgroundColor: null, useCORS: true, windowWidth: target.scrollWidth, windowHeight: target.scrollHeight };
      const canvas = await html2canvas(target, opts);
      const link = document.createElement('a');
      link.download = 'veikkaus-taulukko.png';
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.viewMode = prev;
      localStorage.setItem('tv_view', prev);
      if (typeof window.renderPredictions === 'function') window.renderPredictions();
    }catch(e){
      alert('Kuvan luonti ep√§onnistui: ' + (e && e.message ? e.message : e));
    }
  });
})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(function(){
  document.getElementById('downloadPdfBtn').addEventListener('click', function(){
    const t = (typeof getTournament === 'function') ? getTournament() : null;
    if(!t){ alert('Valitse ensin turnaus.'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const PW = 210; // A4 leveys
    const PH = 297; // A4 korkeus
    const ML = 15, MR = 15, MT = 15;
    let y = MT;
    const usable = PW - ML - MR;

    // V√§rit
    const COL_ORANGE = [249, 115, 22];
    const COL_DARK   = [17, 24, 39];
    const COL_GRAY   = [107, 114, 128];
    const COL_GREEN  = [34, 197, 94];
    const COL_LIGHT  = [243, 244, 246];
    const COL_WHITE  = [255, 255, 255];
    const COL_PURPLE = [124, 58, 237];

    function newPageIfNeeded(needed) {
      if (y + needed > PH - 15) { doc.addPage(); y = MT; }
    }

    function drawHeader() {
      // Oranssi yl√§palkki
      doc.setFillColor(...COL_ORANGE);
      doc.rect(0, 0, PW, 22, 'F');
      doc.setTextColor(...COL_WHITE);
      doc.setFontSize(16); doc.setFont('helvetica','bold');
      doc.text('Turnausveikkaus - ' + t.name, PW/2, 14, { align:'center' });
      y = 28;
    }

    function sectionTitle(title, color) {
      color = color || COL_DARK;
      newPageIfNeeded(12);
      doc.setFillColor(...color);
      doc.roundedRect(ML, y, usable, 9, 2, 2, 'F');
      doc.setTextColor(...COL_WHITE);
      doc.setFontSize(11); doc.setFont('helvetica','bold');
      doc.text(title, ML + 4, y + 6.5);
      y += 13;
    }

    function bodyText(text, indent) {
      indent = indent || 0;
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(10); doc.setFont('helvetica','normal');
      const lines = doc.splitTextToSize(text, usable - indent);
      newPageIfNeeded(lines.length * 5 + 2);
      doc.text(lines, ML + indent, y);
      y += lines.length * 5 + 2;
    }

    function boldText(text, indent) {
      indent = indent || 0;
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(10); doc.setFont('helvetica','bold');
      const lines = doc.splitTextToSize(text, usable - indent);
      newPageIfNeeded(lines.length * 5 + 2);
      doc.text(lines, ML + indent, y);
      y += lines.length * 5 + 2;
    }

    function smallGray(text, indent) {
      indent = indent || 0;
      doc.setTextColor(...COL_GRAY);
      doc.setFontSize(9); doc.setFont('helvetica','normal');
      const lines = doc.splitTextToSize(text, usable - indent);
      newPageIfNeeded(lines.length * 4.5 + 1);
      doc.text(lines, ML + indent, y);
      y += lines.length * 4.5 + 1;
    }

    function spacer(h) { y += h || 4; }

    // --- Apufunktiot dataan ---
    const FIELDS_LOCAL = [
      {key:'lopputulos',label:'Lopputulos'},
      {key:'ekan_maalintekija',label:'Ekan maalintekija'},
      {key:'ekan_maali_aika',label:'Ekan maalin tekoaika'},
      {key:'ekan_jahyn_saaja',label:'Ekan jaahyn saaja'},
      {key:'ekan_jahyn_syy',label:'Ekan jaahyn syy'},
      {key:'montako_jahyja',label:'Montako jaahyda'},
      {key:'parempi_laukasu',label:'Kummalla parempi laukaus%'},
      {key:'parempi_alotus',label:'Kummalla parempi aloitus%'},
      {key:'parempi_torjunta',label:'Kummalla parempi torjunta%'},
      {key:'parempi_alivoima',label:'Kummalla parempi alivoima%'},
      {key:'parempi_ylivoima',label:'Kummalla parempi ylivoima%'},
      {key:'era1',label:'1. era tulos'},
      {key:'era2',label:'2. era tulos'},
      {key:'valmentaja_haasto',label:'Valmentaja haasto'},
      {key:'maali_tyhjiin',label:'Maali tyhjiin'}
    ];

    const PLAYERS_LOCAL = (typeof PLAYERS !== 'undefined') ? PLAYERS : ["Roosa","Timo","Tero","Tiina","Tepa","√Ñiti","Isk√§"];

    function ciEqLocal(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }
    function timeMatchLocal(p,a){
      const parse = s => { const m=(s||'').match(/^(\d{1,2}):(\d{2})$/); return m ? parseInt(m[1])*60+parseInt(m[2]) : null; };
      const ps=parse(p), as=parse(a); return ps!==null && as!==null && Math.abs(ps-as)<=60;
    }
    function fieldMatchLocal(key,p,a){
      if(!a||!p) return false;
      if(key==='ekan_maali_aika') return timeMatchLocal(p,a);
      return ciEqLocal(p,a);
    }
    function calcMatchPtsLocal(t,matchId,player){
      const preds=(t.predictions[matchId]||{})[player]||{};
      const actual=t.actuals[matchId]||{};
      let s=0;
      FIELDS_LOCAL.forEach(f=>{ if(actual[f.key]!==undefined && actual[f.key]!=='' && fieldMatchLocal(f.key, preds[f.key]||'', actual[f.key])) s++; });
      return s;
    }
    function calcTotalsLocal(t){
      const totals={}; PLAYERS_LOCAL.forEach(p=>totals[p]=0);
      (t.matches||[]).forEach(m=>{
        PLAYERS_LOCAL.forEach(p=>{ totals[p]+=calcMatchPtsLocal(t,m.id,p); });
      });
      if(t.topThreePrediction){
        const actual=t.actualTopThree||[];
        PLAYERS_LOCAL.forEach(p=>{
          const pred=t.topThreePrediction[p]||[];
          if(pred.length===3){ let pts=0; pred.forEach((team,i)=>{ if(team && actual[i] && ciEqLocal(team,actual[i])) pts+=2; }); totals[p]+=pts; }
        });
      }
      return totals;
    }

    // ========================
    // SIVU 1 ‚Äì KANSILEHTI
    // ========================
    drawHeader();

    // P√§iv√§m√§√§r√§
    doc.setTextColor(...COL_GRAY);
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Luotu: ' + new Date().toLocaleDateString('fi-FI'), PW - MR, y, { align:'right' });
    spacer(6);

    // Iso pistekuvio ‚Äì podium
    const totals = calcTotalsLocal(t);
    const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]);

    sectionTitle('LOPPUSIJOITUKSET', COL_ORANGE);

    const medals = ['1.', '2.', '3.'];
    const cardW = (usable - 8) / 3;
    const podiumColors = [[255,215,0], [192,192,192], [205,127,50]];
    sorted.slice(0,3).forEach(([name, pts], i) => {
      const cx = ML + i * (cardW + 4);
      const cardH = 28;
      const cy = y;
      doc.setFillColor(...podiumColors[i]);
      doc.roundedRect(cx, cy, cardW, cardH, 3, 3, 'F');
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(14); doc.setFont('helvetica','bold');
      doc.text(medals[i], cx + cardW/2, cy + 8, { align:'center' });
      doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.text(name, cx + cardW/2, cy + 16, { align:'center' });
      doc.setFontSize(11); doc.setFont('helvetica','bold');
      doc.text(pts + ' p', cx + cardW/2, cy + 23, { align:'center' });
    });
    y += 34;

    // Kaikki pisteet taulukko
    newPageIfNeeded(8 + sorted.length * 7);
    const colX = [ML, ML + 50, ML + 90];
    doc.setFillColor(...COL_LIGHT);
    doc.rect(ML, y, usable, 7, 'F');
    doc.setTextColor(...COL_GRAY);
    doc.setFontSize(9); doc.setFont('helvetica','bold');
    doc.text('Sija', colX[0]+2, y+5);
    doc.text('Pelaaja', colX[1], y+5);
    doc.text('Pisteet', colX[2], y+5);
    y += 7;
    sorted.forEach(([name, pts], i) => {
      newPageIfNeeded(7);
      doc.setFillColor(i%2===0 ? 255 : 248, i%2===0 ? 255 : 248, i%2===0 ? 255 : 250);
      doc.rect(ML, y, usable, 7, 'F');
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(10); doc.setFont('helvetica', i===0?'bold':'normal');
      doc.text((i+1)+'.', colX[0]+2, y+5);
      if(i >= 3){
        doc.setFontSize(8); doc.setTextColor(139,90,43);
        doc.text('(poo)', colX[0]+10, y+5);
        doc.setFontSize(10); doc.setTextColor(...COL_DARK);
      }
      doc.setFont('helvetica', i===0?'bold':'normal');
      doc.text(name, colX[1], y+5);
      doc.setFont('helvetica','bold');
      doc.text(pts + ' p', colX[2], y+5);
      y += 7;
    });
    spacer(8);

    // ========================
    // KOLMEN K√ÑRKI ‚Äì VEIKKAUKSET
    // ========================
    const actualTopThree = t.actualTopThree || [];
    const hasTopThreeData = actualTopThree.some(x => x && x !== '');
    if(hasTopThreeData || t.topThreePrediction){
      sectionTitle('KOLMEN KARKI ‚Äì VEIKKAUKSET', COL_ORANGE);

      // Oikeat sijoitukset
      newPageIfNeeded(20);
      boldText('Oikea jarjestys:');
      spacer(2);
      ['1. sija', '2. sija', '3. sija'].forEach((label, i) => {
        newPageIfNeeded(7);
        doc.setFillColor(...podiumColors[i]);
        doc.roundedRect(ML, y-4, usable, 6, 1,1,'F');
        doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.setTextColor(...COL_DARK);
        doc.text(label + ':', ML+3, y);
        doc.setFont('helvetica','normal');
        doc.text(actualTopThree[i] || '‚Äî', ML+30, y);
        y += 7;
      });
      spacer(4);

      // Pelaajien veikkaukset + pisteet
      if(t.topThreePrediction){
        boldText('Pelaajien veikkaukset:');
        spacer(2);

        // Header
        newPageIfNeeded(8 + PLAYERS_LOCAL.length * 8);
        doc.setFillColor(...COL_LIGHT);
        doc.rect(ML, y, usable, 7, 'F');
        doc.setTextColor(...COL_GRAY);
        doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.text('Pelaaja', ML+3, y+5);
        doc.text('1. sija', ML+40, y+5);
        doc.text('2. sija', ML+80, y+5);
        doc.text('3. sija', ML+120, y+5);
        doc.text('Pisteet', PW-MR-8, y+5, {align:'right'});
        y += 7;

        // Jokainen pelaaja
        const t3PlayerPts = PLAYERS_LOCAL.map(p => {
          const pred = t.topThreePrediction[p] || [];
          let pts = 0;
          pred.forEach((team, i) => {
            if(team && actualTopThree[i] && ciEqLocal(team, actualTopThree[i])) pts += 2;
          });
          return { name: p, pred, pts };
        }).sort((a,b) => b.pts - a.pts);

        t3PlayerPts.forEach(({name, pred, pts}, i) => {
          newPageIfNeeded(8);
          doc.setFillColor(i%2===0 ? 255 : 248, i%2===0 ? 255 : 248, i%2===0 ? 255 : 250);
          doc.rect(ML, y, usable, 7, 'F');

          doc.setFontSize(9); doc.setFont('helvetica', pts > 0 ? 'bold' : 'normal');
          doc.setTextColor(...COL_DARK);
          doc.text(name, ML+3, y+5);

          [0,1,2].forEach((idx, col) => {
            const team = pred[idx] || '‚Äî';
            const isCorrect = actualTopThree[idx] && team && ciEqLocal(team, actualTopThree[idx]);
            doc.setTextColor(...(isCorrect ? [22,163,74] : COL_GRAY));
            doc.setFont('helvetica', isCorrect ? 'bold' : 'normal');
            doc.text(team, ML+40 + col*40, y+5);
          });

          doc.setTextColor(...(pts > 0 ? [22,163,74] : COL_DARK));
          doc.setFont('helvetica','bold');
          doc.text(pts + ' p', PW-MR-8, y+5, {align:'right'});
          y += 7;
        });
      }
      spacer(8);
    }

    // ========================
    // OTTELUKOHTAISET PISTEET
    // ========================
    sectionTitle('PISTEET OTTELUITTAIN', COL_DARK);

    (t.matches||[]).forEach(m => {
      newPageIfNeeded(10 + PLAYERS_LOCAL.length * 6 + 14);

      // Ottelun otsikko
      doc.setFillColor(...COL_LIGHT);
      doc.roundedRect(ML, y, usable, 8, 2, 2, 'F');
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(10); doc.setFont('helvetica','bold');

      const actual = t.actuals[m.id] || {};
      const scoreStr = actual['lopputulos'] ? '  (' + actual['lopputulos'] + ')' : '';
      doc.text(m.name + scoreStr, ML+4, y+5.5);
      y += 10;

      // Pisteet per pelaaja t√§ss√§ ottelussa
      const matchPts = PLAYERS_LOCAL.map(p => ({ name: p, pts: calcMatchPtsLocal(t, m.id, p) }))
        .sort((a,b)=>b.pts-a.pts);
      const barMax = Math.max(...matchPts.map(x=>x.pts), 1);
      const barW = usable - 60;

      matchPts.forEach(({name, pts}, i) => {
        newPageIfNeeded(7);
        doc.setTextColor(...COL_DARK);
        doc.setFontSize(9); doc.setFont('helvetica', pts===matchPts[0].pts?'bold':'normal');
        doc.text(name, ML+2, y+4.5);
        // Palkki
        const fill = (pts/barMax) * barW;
        doc.setFillColor(...COL_LIGHT);
        doc.roundedRect(ML+35, y+1, barW, 5, 1,1,'F');
        if(fill > 0){
          doc.setFillColor(...(pts===matchPts[0].pts ? COL_ORANGE : [147,197,253]));
          doc.roundedRect(ML+35, y+1, fill, 5, 1,1,'F');
        }
        doc.setTextColor(...COL_DARK);
        doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.text(pts + ' p', ML+35+barW+3, y+4.5);
        y += 7;
      });
      spacer(4);
    });

    // ========================
    // PARAS SUORITUS
    // ========================
    spacer(2);
    sectionTitle('PARHAAT SUORITUKSET', COL_PURPLE);

    let bestMatch = null;
    const playerBests = {};
    PLAYERS_LOCAL.forEach(p => playerBests[p] = { matchName: '-', pts: 0 });
    (t.matches||[]).forEach(m=>{
      PLAYERS_LOCAL.forEach(p=>{
        const pts = calcMatchPtsLocal(t, m.id, p);
        if(!bestMatch || pts > bestMatch.pts) bestMatch = {player:p, matchName:m.name, pts};
        if(pts > playerBests[p].pts) playerBests[p] = {matchName: m.name, pts};
      });
    });

    if(bestMatch){
      newPageIfNeeded(22);
      doc.setFillColor(...COL_PURPLE);
      doc.roundedRect(ML, y, usable, 18, 3,3,'F');
      doc.setTextColor(...COL_WHITE);
      doc.setFontSize(9); doc.setFont('helvetica','normal');
      doc.text('Paras yksittainen suoritus', ML+4, y+5);
      doc.setFontSize(14); doc.setFont('helvetica','bold');
      doc.text(bestMatch.player, ML+4, y+12);
      doc.setFontSize(9); doc.setFont('helvetica','normal');
      doc.text(bestMatch.matchName, ML+4, y+17);
      doc.setFontSize(16); doc.setFont('helvetica','bold');
      doc.text(bestMatch.pts + ' p', PW-MR-4, y+12, {align:'right'});
      y += 22;
    }

    spacer(4);
    boldText('Pelaajien parhaat ottelut:');
    PLAYERS_LOCAL.forEach(p => {
      const b = playerBests[p];
      newPageIfNeeded(6);
      doc.setFontSize(9);
      doc.setFont('helvetica','bold'); doc.setTextColor(...COL_DARK);
      doc.text(p + ':', ML+2, y);
      doc.setFont('helvetica','normal'); doc.setTextColor(...COL_GRAY);
      doc.text(b.matchName + ' ‚Äì ' + b.pts + ' p', ML+30, y);
      y += 5.5;
    });

    // ========================
    // HAUSKOJA TILASTOJA
    // ========================
    spacer(6);
    sectionTitle('TILASTOJA VASTAUKSISTA', COL_DARK);

    // Ker√§√§ kaikki veikkaustilastot kentitt√§in
    const fieldStats = {};
    FIELDS_LOCAL.forEach(f => fieldStats[f.key] = { label: f.label, answers: {}, correct: 0, total: 0 });

    (t.matches||[]).forEach(m=>{
      const actual = t.actuals[m.id] || {};
      PLAYERS_LOCAL.forEach(p=>{
        const preds = (t.predictions[m.id]||{})[p]||{};
        FIELDS_LOCAL.forEach(f=>{
          const pv = preds[f.key]||'';
          const av = actual[f.key]||'';
          if(pv){
            fieldStats[f.key].answers[pv] = (fieldStats[f.key].answers[pv]||0)+1;
            fieldStats[f.key].total++;
            if(av && fieldMatchLocal(f.key, pv, av)) fieldStats[f.key].correct++;
          }
        });
      });
    });

    // Kentt√§ jossa eniten oikeita vastauksia prosenteissa
    boldText('Helpoin ja vaikein kohde:');
    spacer(2);
    const fieldPcts = FIELDS_LOCAL
      .filter(f => fieldStats[f.key].total > 0)
      .map(f => ({
        label: f.label,
        pct: Math.round(fieldStats[f.key].correct / fieldStats[f.key].total * 100),
        correct: fieldStats[f.key].correct,
        total: fieldStats[f.key].total
      }))
      .sort((a,b) => b.pct - a.pct);

    if(fieldPcts.length > 0){
      const easiest = fieldPcts[0];
      const hardest = fieldPcts[fieldPcts.length-1];
      newPageIfNeeded(14);
      doc.setFillColor(220,252,231);
      doc.roundedRect(ML, y, usable/2-2, 12, 2,2,'F');
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(8); doc.setFont('helvetica','bold');
      doc.text('Helpoin: ' + easiest.label, ML+3, y+5);
      doc.setFont('helvetica','normal');
      doc.text(easiest.correct + '/' + easiest.total + ' oikein (' + easiest.pct + '%)', ML+3, y+10);

      doc.setFillColor(254,226,226);
      doc.roundedRect(ML+usable/2+2, y, usable/2-2, 12, 2,2,'F');
      doc.setTextColor(...COL_DARK);
      doc.setFontSize(8); doc.setFont('helvetica','bold');
      doc.text('Vaikein: ' + hardest.label, ML+usable/2+5, y+5);
      doc.setFont('helvetica','normal');
      doc.text(hardest.correct + '/' + hardest.total + ' oikein (' + hardest.pct + '%)', ML+usable/2+5, y+10);
      y += 16;
    }

    // (Todennakoisimmaksi veikattuja osiot poistettu)

    // ========================
    // OIKEIDEN VASTAUSTEN PROSENTIT PER KYSYMYS
    // ========================
    spacer(6);
    sectionTitle('OIKEAT VASTAUKSET ‚Äì MONTAKO ARVASI OIKEIN', COL_GREEN);

    const fieldPctsAll = FIELDS_LOCAL.map(f => ({
      label: f.label,
      correct: fieldStats[f.key].correct,
      total: fieldStats[f.key].total,
      pct: fieldStats[f.key].total > 0 ? Math.round(fieldStats[f.key].correct / fieldStats[f.key].total * 100) : null
    })).filter(f => f.total > 0);

    if(fieldPctsAll.length > 0){
      // Header
      newPageIfNeeded(8 + fieldPctsAll.length * 8);
      doc.setFillColor(...COL_LIGHT);
      doc.rect(ML, y, usable, 7, 'F');
      doc.setTextColor(...COL_GRAY);
      doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.text('Kysymys', ML+3, y+5);
      doc.text('Oikein', PW-MR-30, y+5);
      doc.text('%', PW-MR-8, y+5, {align:'right'});
      y += 7;

      const sortedByPct = [...fieldPctsAll].sort((a,b) => (b.pct||0)-(a.pct||0));
      sortedByPct.forEach(({label, correct, total, pct}, i) => {
        newPageIfNeeded(8);
        const isEven = i%2===0;
        doc.setFillColor(isEven ? 255 : 248, isEven ? 255 : 248, isEven ? 255 : 250);
        doc.rect(ML, y, usable, 7, 'F');

        // Color bar background
        const barW2 = 40;
        doc.setFillColor(230,230,230);
        doc.roundedRect(PW-MR-barW2-14, y+1.5, barW2, 4, 1,1,'F');
        if(pct !== null && pct > 0){
          const fillW = (pct/100) * barW2;
          const barColor = pct >= 60 ? [34,197,94] : pct >= 30 ? [251,146,60] : [239,68,68];
          doc.setFillColor(...barColor);
          doc.roundedRect(PW-MR-barW2-14, y+1.5, fillW, 4, 1,1,'F');
        }

        doc.setTextColor(...COL_DARK);
        doc.setFontSize(9); doc.setFont('helvetica','normal');
        doc.text(label, ML+3, y+5);
        doc.text(correct + '/' + total, PW-MR-barW2-18, y+5, {align:'right'});
        doc.setFont('helvetica','bold');
        doc.text((pct !== null ? pct : '-') + '%', PW-MR-4, y+5, {align:'right'});
        y += 7;
      });
    }

    // (Otteluiden oikeat vastaukset poistettu PDF:st√§)

    // ========================
    // KIITOSSIVU
    // ========================
    doc.addPage();
    y = 0;

    // Tumma taustapalkki koko sivulle
    doc.setFillColor(...COL_DARK);
    doc.rect(0, 0, PW, PH, 'F');

    // Oranssi koriste yl√§reunassa
    doc.setFillColor(...COL_ORANGE);
    doc.rect(0, 0, PW, 6, 'F');
    doc.rect(0, PH-6, PW, 6, 'F');

    doc.setTextColor(...COL_ORANGE);
    doc.setFontSize(28); doc.setFont('helvetica','bold');
    doc.text('Kiitos osallistumisesta!', PW/2, 70, {align:'center'});

    doc.setTextColor(...COL_WHITE);
    doc.setFontSize(14); doc.setFont('helvetica','normal');
    doc.text('Turnaus: ' + t.name, PW/2, 88, {align:'center'});

    // Voittaja iso
    const winner = sorted[0];
    doc.setFillColor(...COL_ORANGE);
    doc.roundedRect(PW/2-40, 98, 80, 30, 4,4,'F');
    doc.setTextColor(...COL_DARK);
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('TURNAUKSEN VOITTAJA', PW/2, 108, {align:'center'});
    doc.setFontSize(18); doc.setFont('helvetica','bold');
    doc.text(winner ? winner[0] : '-', PW/2, 120, {align:'center'});
    doc.setFontSize(12);
    doc.text(winner ? winner[1] + ' pistetta' : '', PW/2, 127, {align:'center'});

    // Kaikki sijoitukset
    let ky2 = 148;
    doc.setTextColor(...[148,163,184]);
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Kaikki sijoitukset:', PW/2, ky2, {align:'center'});
    ky2 += 7;
    sorted.forEach(([name, pts], i) => {
      const rankStr = (i+1)+'. ' + name + ' - ' + pts + ' p' + (i >= 3 ? '  (poo)' : '');
      doc.setTextColor(...(i < 3 ? COL_WHITE : [148,163,184]));
      doc.setFontSize(i===0?12:10); doc.setFont('helvetica', i===0?'bold':'normal');
      doc.text(rankStr, PW/2, ky2, {align:'center'});
      ky2 += i===0 ? 8 : 6;
    });

    // T√§hdet koristelu ‚Äì asetetaan dynaamisesti sijoituslistan j√§lkeen
    doc.setTextColor(...COL_ORANGE);
    doc.setFontSize(18);
    doc.text('* * *', PW/2, ky2 + 10, {align:'center'});

    doc.setTextColor(...[148,163,184]);
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Turnausveikkaus - raportti ' + new Date().toLocaleDateString('fi-FI'), PW/2, 275, {align:'center'});

    // Tallenna
    const safeName = (t.name||'turnaus').replace(/[^a-zA-Z0-9_\-]/g,'_');
    doc.save('turnausveikkaus_' + safeName + '.pdf');
  });
})();
</script>
</body>
</html>
