<!DOCTYPE html>
<html lang="fi">
<head>
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>üèí Turnausveikkaus</title>
  <style>
    :root { --bg:#f7f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#f97316; --primary-hover:#ea580c; --border:#e5e7eb; --ok:#22c55e; --dark:#111827; }
    *{ box-sizing:border-box } html,body{ margin:0; padding:0 }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; line-height:1.5; padding:12px }
    @media (prefers-color-scheme: dark) {
      .score-card { background:#ffffff !important; color:#000000 !important; }
      .score-card .name { color:#000000 !important; font-weight:700; }
      :root { --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --border:#334155; --primary:#f97316; --dark:#f8fafc; }
      input, select { background:#1e293b !important; color:#ffffff !important; border-color:#475569 !important; }
      body { background:var(--bg); color:var(--text); }
      .card, .person-card, .t3-card, table th, table td { background:var(--card) !important; }
      .score-card { background:var(--card); border-color:var(--border); }
      .tabs .tab { background:var(--card); color:var(--text); }
    }
    h1{ text-align:center; margin:0 0 12px; font-size:22px } h2{ margin:0 0 10px; font-size:16px }
    .layout{ max-width:960px; margin:0 auto; display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:980px){ .layout{ grid-template-columns:360px 1fr } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .field{ margin-bottom:8px }
    label{ font-weight:600; font-size:14px; display:block; margin-bottom:6px }
    input[type="text"], input[type="number"], input[type="datetime-local"], select{ width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fff }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .btn{ display:inline-flex; justify-content:center; align-items:center; gap:8px; border:none; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; background:var(--primary); color:#fff; font-size:15px; }
    .btn.small{ padding:10px; font-size:14px; } .btn:disabled{ opacity:.6; cursor:not-allowed } .btn:hover:not(:disabled){ background:var(--primary-hover) }
    .btn.secondary{ background:#fff; color:#111; border:1px solid var(--border); }
    .btn.secondary:hover:not(:disabled){ background:#f3f4f6; }
    .btn.danger{ background:#dc2626; } .btn.danger:hover:not(:disabled){ background:#b91c1c; }
    .btn.green{ background:#22c55e; } .btn.green:hover:not(:disabled){ background:#16a34a; }
    .muted{ color:var(--muted); font-size:13px } .grid{ display:grid; gap:10px } .separator{ height:1px; background:var(--border); margin:12px 0 }
    .score-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px }
    .score-card{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center }
    .score-card .name{ font-weight:700; font-size:14px } .score-card .pts{ font-size:13px; color:#111 }
    .stack{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .tabs{ display:flex; border:1px solid var(--border); border-radius:10px; overflow:hidden }
    .tab{ flex:1; text-align:center; padding:10px; background:#fff; cursor:pointer; font-weight:700; color:var(--text); }
    .tab.active{ background:var(--dark); color:#fff !important; }
    .person-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff }
    .person-title{ font-weight:800; margin-bottom:8px }
    .kv{ display:grid; grid-template-columns:1fr; gap:6px }
    .kv-row{ display:grid; grid-template-columns:180px 1fr; gap:8px; align-items:center }
    @media(max-width:420px){ .kv-row{ grid-template-columns:140px 1fr } }
    .kv-label{ font-weight:600 }
    .kv-row.correct { background-color:#86efac !important; border-radius:8px; padding:4px 6px; }
    .kv-row.incorrect { background-color:#fca5a5 !important; border-radius:8px; padding:4px 6px; }
    .kv-row.correct input, .kv-row.correct select { background-color:#86efac !important; color:#000 !important; }
    .kv-row.incorrect input, .kv-row.incorrect select { background-color:#fca5a5 !important; color:#000 !important; }
    .kv-row.correct .kv-label, .kv-row.incorrect .kv-label { color:#000 !important; }
    .correct{ background-color:#86efac !important; }
    .incorrect{ background-color:#fca5a5 !important; }
    .score-combo{ display:flex; align-items:center; gap:6px } .score-combo input{ width:64px; text-align:center } .dash{ font-weight:800 }
    .time-combo{ display:flex; align-items:center; gap:6px; }
    .time-combo input{ width:64px; text-align:center; }
    .colon{ font-weight:800; }
    .pts-badge{ display:inline-block; background:#111827; color:#fff; font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px; }
    .card-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fafafa; font-size:12px }
    .t3-grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media(min-width:640px){ .t3-grid{ grid-template-columns:1fr 1fr; } }
    .t3-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .t3-title{ font-weight:800; margin-bottom:8px; font-size:15px; }
    .t3-row{ display:grid; grid-template-columns:1fr; gap:8px; align-items:center; margin-bottom:6px; }
    .table-wrap{ width:100%; overflow-x:auto; overflow-y:hidden; border-radius:10px; }
    .table-wrap table{ min-width:1000px; width:max-content; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    th,td{ border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; text-align:left; vertical-align:top; background:#fff }
    th:first-child,td:first-child{ border-left:1px solid var(--border) } tr:first-child th{ border-top:1px solid var(--border) }
    .sticky-top{ position:sticky; top:0; z-index:5; background:#fafafa }
    .sticky-left{ position:sticky; left:0; z-index:4; background:#fafafa }
    .sticky-corner{ z-index:6 }
    table td.correct{ background-color:#86efac !important; }
    table td.incorrect{ background-color:#fca5a5 !important; }
    .actuals-card.person-card{ padding:14px; }
    .actuals-card .kv-row{ grid-template-columns:200px 1fr; }
    @media(max-width:480px){ .actuals-card .kv-row{ grid-template-columns:150px 1fr; } }
    .actuals-card input, .actuals-card select{ padding:14px 16px; font-size:18px; border-radius:12px; }
    #loginScreen{ max-width:420px; margin:60px auto; text-align:center; }
    .pin-dot{ width:16px; height:16px; border-radius:50%; border:2px solid var(--border); background:transparent; transition:background 0.15s; }
    .pin-dot.filled{ background:var(--primary); border-color:var(--primary); }
    .pin-key{ padding:18px; font-size:20px; font-weight:700; border:2px solid var(--border); border-radius:14px; background:var(--card); color:var(--text); cursor:pointer; transition:all 0.1s; }
    .pin-key:hover{ border-color:var(--primary); background:var(--primary); color:#fff; }
    .pin-key:active{ transform:scale(0.93); }
    .player-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:24px; }
    .player-btn{ padding:20px; font-size:17px; font-weight:700; border:2px solid var(--border); border-radius:14px; background:var(--card); color:var(--text); cursor:pointer; transition:all 0.15s; }
    .player-btn:hover{ border-color:var(--primary); background:var(--primary); color:#fff; }
    .player-btn.admin{ border-color:#7c3aed; }
    .player-btn.admin:hover{ background:#7c3aed; border-color:#7c3aed; }
    #fb-status{ position:fixed; top:0; left:0; right:0; padding:6px; text-align:center; font-size:13px; font-weight:700; z-index:9999; transition:opacity 0.5s; opacity:0; pointer-events:none; }
    .player-status-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; }
    .player-status-card{ border-radius:10px; padding:8px 10px; text-align:center; font-weight:700; font-size:13px; border:2px solid; }
    .player-status-card.voted{ background:#dcfce7; border-color:#22c55e; color:#166534; }
    .player-status-card.not-voted{ background:#fee2e2; border-color:#dc2626; color:#991b1b; }
    .player-status-card.done{ background:#dbeafe; border-color:#3b82f6; color:#1e40af; }
    .lock-banner{ background:#dc2626; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; text-align:center; margin-bottom:10px; }
    .open-banner{ background:#22c55e; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; text-align:center; margin-bottom:10px; }
    #countdown{ font-size:13px; color:var(--muted); text-align:center; margin-bottom:8px; }
  </style>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
</head>
<body>

<div id="fb-status"></div>

<!-- KIRJAUTUMINEN -->
<div id="loginScreen">
  <div style="font-size:48px;margin-bottom:8px">üèí</div>
  <h1 style="font-size:26px;margin:0 0 6px">Turnausveikkaus</h1>

  <!-- Vaihe 1: valitse nimi -->
  <div id="loginStep1">
    <p class="muted">Valitse nimesi</p>
    <div class="player-grid" id="playerGrid"></div>
  </div>

  <!-- Vaihe 2: sy√∂t√§ PIN -->
  <div id="loginStep2" style="display:none;margin-top:16px">
    <p class="muted">Tervetuloa, <strong id="loginName"></strong>!</p>
    <p class="muted" style="margin-top:4px">Sy√∂t√§ PIN-koodi</p>
    <div style="display:flex;gap:8px;justify-content:center;margin:16px 0" id="pinDots"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:220px;margin:0 auto">
      <button class="pin-key" data-v="1">1</button>
      <button class="pin-key" data-v="2">2</button>
      <button class="pin-key" data-v="3">3</button>
      <button class="pin-key" data-v="4">4</button>
      <button class="pin-key" data-v="5">5</button>
      <button class="pin-key" data-v="6">6</button>
      <button class="pin-key" data-v="7">7</button>
      <button class="pin-key" data-v="8">8</button>
      <button class="pin-key" data-v="9">9</button>
      <button class="pin-key" data-v="back" style="background:#6b7280">‚Üê</button>
      <button class="pin-key" data-v="0">0</button>
      <button class="pin-key" data-v="clear" style="background:#6b7280">‚úï</button>
    </div>
    <p id="pinError" style="color:#dc2626;font-weight:700;margin-top:12px;min-height:20px"></p>
    <button class="btn small secondary" style="margin-top:8px" onclick="window._backToNames()">‚Üê Vaihda nimi</button>
  </div>
</div>

<!-- P√Ñ√ÑSOVELLUS -->
<div id="appScreen" style="display:none">
  <div style="max-width:960px;margin:0 auto 10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
    <h1 style="margin:0;font-size:20px">üèí Turnausveikkaus</h1>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="currentUserBadge" style="font-weight:700;font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:4px 12px;"></span>
      <button class="btn small secondary" onclick="window._logout()">Vaihda k√§ytt√§j√§</button>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <h2>Turnaus</h2>
      <div class="field">
        <label>Valitse turnaus</label>
        <select id="tournamentSelect"></select>
      </div>
      <div id="adminTournamentTools" style="display:none">
        <div class="field">
          <label>Luo uusi turnaus</label>
          <input id="newTournamentName" type="text" placeholder="Esim. MM 2026" />
        </div>
        <div class="field">
          <button id="createTournament" class="btn small" style="width:100%">Luo turnaus</button>
        </div>
        <div id="finishTournamentArea" style="display:none">
          <button id="finishTournament" class="btn small danger" style="width:100%;margin-top:6px">üèÅ P√§√§t√§ turnaus</button>
          <p class="muted" style="margin-top:4px;font-size:12px">Lukitsee turnauksen kokonaan.</p>
        </div>
        <div id="tournamentFinishedBadge" style="display:none">
          <div style="background:#22c55e;color:#fff;border-radius:10px;padding:10px;text-align:center;font-weight:700;margin-top:6px">‚úÖ Turnaus p√§√§ttynyt</div>
        </div>
        <div class="field" id="deleteTournamentArea" style="display:none;margin-top:6px">
          <button id="deleteTournament" class="btn small danger" style="width:100%">üóëÔ∏è Poista turnaus</button>
        </div>
      </div>

      <div class="separator"></div>
      <h2>Ottelut</h2>
      <div class="field">
        <label>Valitse ottelu</label>
        <select id="matchSelect"></select>
      </div>
      <div id="adminMatchTools" style="display:none">
        <div class="field">
          <label>Luo uusi ottelu</label>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-weight:700;font-size:16px;white-space:nowrap">SUOMI vs</span>
            <input id="newMatchName" type="text" placeholder="RUOTSI" style="text-transform:uppercase;flex:1" />
          </div>
        </div>
        <div class="field">
          <label>Pelin alkuaika (veikkaukset lukittuvat)</label>
          <input id="newMatchTime" type="datetime-local" />
        </div>
        <div class="field">
          <button id="createMatch" class="btn small" style="width:100%">Luo ottelu</button>
        </div>
        <div class="field" id="deleteMatchArea" style="display:none;margin-top:4px">
          <button id="deleteMatch" class="btn small danger" style="width:100%">üóëÔ∏è Poista ottelu</button>
        </div>
      </div>

      <div class="separator"></div>
      <div class="stack" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Kolmen k√§rki</h2>
        <button id="toggleTop3" class="btn small secondary">Piilota</button>
      </div>
      <div id="topThreeArea"></div>
      <div id="saveTop3Row" class="stack" style="margin-top:8px">
        <button id="saveTopThree" class="btn small">Tallenna veikkaukset</button>
      </div>

      <div class="separator"></div>
      <h2>Data</h2>
      <div class="stack">
        <button id="exportBtn" class="btn small secondary">Vie JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="btn small secondary" style="display:none">Tuo JSON</button>
        <button id="screenshotTableBtn" class="btn small green">üì∑ Kuva</button>
        <button id="downloadPdfBtn" class="btn small" style="background:#7c3aed">üìÑ PDF</button>
      </div>
      <p class="muted" style="margin-top:6px">‚òÅÔ∏è Data tallentuu Firebase-pilveen</p>
      <div id="adminPinTools" style="display:none;margin-top:8px">
        <div class="separator"></div>
        <div class="stack" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">üîê PIN-koodit</h2>
          <button id="togglePins" class="btn small secondary">Piilota</button>
        </div>
        <div id="pinManageArea"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Yhteispisteet</h2>
        <div id="scoreboard"></div>
      </div>

      <div class="card" id="statsCard" style="display:none">
        <h2>üèÜ Turnauksen tilastot</h2>
        <div id="statsArea"></div>
      </div>

      <div class="card" id="adminStatusCard" style="display:none">
        <h2>üë• Kuka on veikannut?</h2>
        <div id="playerStatusArea"></div>
      </div>

      <div class="card">
        <div class="stack" style="justify-content:space-between;margin-bottom:8px">
          <h2 style="margin:0">Ottelun veikkaukset</h2>
          <div class="tabs" id="viewTabs" style="display:none">
            <div id="tabTable" class="tab">Taulukko</div>
            <div id="tabCards" class="tab active">Kortit</div>
          </div>
        </div>
        <div id="matchLockBanner"></div>
        <div id="countdown"></div>
        <div id="predictionsArea"><p class="muted">Valitse turnaus ja ottelu.</p></div>
      </div>

      <div class="card">
        <h2>Ottelun tulos (faktat)</h2>
        <div id="actualsArea"><p class="muted">Valitse ottelu.</p></div>
        <div style="margin-top:10px;display:flex;justify-content:flex-end">
          <button id="refreshCheck" class="btn small">P√§ivit√§ & tarkasta</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAsUte6gqukH14_80R6QE-sYR8d_nnaAFA",
  authDomain: "turnausveikkaus.firebaseapp.com",
  projectId: "turnausveikkaus",
  storageBucket: "turnausveikkaus.firebasestorage.app",
  messagingSenderId: "102156409247",
  appId: "1:102156409247:web:25a4d876f8a7fdf0e5c5aa"
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const DATA_DOC = doc(db, "app", "data");
const PINS_DOC = doc(db, "app", "pins");

// ============================
// VAKIOT
// ============================
const PLAYERS = ["Roosa","Timo","Tero","Tiina","Tepa","√Ñiti","Isk√§"];
const ADMIN = "Tero";
const PENALTY_REASONS = ['Koukkaaminen','Mailasta kiinnipit√§minen','Est√§minen','P√§√§h√§n kohdistuva taklaus','Huitominen','V√§kivaltaisuus','Rynt√§ys','Tappelu','Liian monta pelaajaa j√§√§ll√§','Poikittainen maila','Kampitus','Kiinnipit√§minen','Mailan tai esineen heitt√§minen','Laitataklaus','Sukeltaminen','Kyyn√§rp√§√§taklaus','Pelin viivytt√§minen','Kiekon sulkeminen','Korkea maila','Sel√§st√§ taklaaminen','K√§yt√∂srangaistus','P√§√§ll√§ iskeminen','Polvitaklaus','Mailan p√§√§ll√§ ly√∂minen tai sen yritys','Keih√§st√§minen','Jalkapyyhk√§isy','Rikkoutuneella mailalla pelaaminen','V√§√§r√§ varuste','Pelaajaa ei ole merkitty p√∂yt√§kirjaan','Potkaisee tai sylkee','Ei j√§√§hy√§'];
const GOAL_SCORERS = ['Juuse Saros (MV)','Joonas Korpisalo (MV)','Kevin Lankinen (MV)','Miro Heiskanen (P)','Esa Lindell (P)','Niko Mikkola (P)','Henri Jokiharju (P)','Rasmus Ristolainen (P)','Nikolas Matinpalo (P)','Olli M√§√§tt√§ (P)','Mikko Lehtonen (P)','Mikael Granlund (H)','Roope Hintz (H)','Mikko Rantanen (H)','Teuvo Ter√§v√§inen (H)','Sebastian Aho (H)','Artturi Lehkonen (H)','Eetu Luostarinen (H)','Anton Lundell (H)','Kaapo Kakko (H)','Eeli Tolvanen (H)','Erik Haula (H)','Joel Armia (H)','Oliver Kapanen (H)','Joel Kiviranta (H)','Ei maalia'];
const PENALTY_TAKERS = [...GOAL_SCORERS.slice(0,-1),'Ei j√§√§hy√§','Joukkue rangaistus'];
const FIELDS = [
  {key:'lopputulos',label:'Lopputulos'},{key:'ekan_maalintekija',label:'Ekan maalintekij√§'},
  {key:'ekan_maali_aika',label:'Ekan maalin tekoaika'},{key:'ekan_jahyn_saaja',label:'Ekan j√§√§hyn saaja'},
  {key:'ekan_jahyn_syy',label:'Ekan j√§√§hyn syy'},{key:'montako_jahyja',label:'Montako j√§√§hyd√§'},
  {key:'parempi_laukasu',label:'Kummalla parempi laukaus%'},{key:'parempi_alotus',label:'Kummalla parempi aloitus%'},
  {key:'parempi_torjunta',label:'Kummalla parempi torjunta%'},{key:'parempi_alivoima',label:'Kummalla parempi alivoima%'},
  {key:'parempi_ylivoima',label:'Kummalla parempi ylivoima%'},{key:'era1',label:'1. er√§ tulos'},
  {key:'era2',label:'2. er√§ tulos'},{key:'valmentaja_haasto',label:'Valmentaja haasto'},{key:'maali_tyhjiin',label:'Maali tyhjiin'}
];
const ONE_X_TWO = new Set(['parempi_laukasu','parempi_alotus','parempi_torjunta','parempi_alivoima','parempi_ylivoima','era1','era2']);
const KYLLA_EI = new Set(['valmentaja_haasto','maali_tyhjiin']);
const NUMBER_K = new Set(['montako_jahyja']);

// ============================
// TILA
// ============================
let data = {tournaments:[]};
let pins = {};
let tid = null; // selected tournament id
let mid = null; // selected match id
let viewMode = 'cards';
let currentUser = null;
let isSaving = false;
let saveQueued = false;
let cdTimer = null;      // countdown setInterval handle
let cdRunning = false;   // guard: is countdown active?

// ============================
// HELPERS
// ============================
const $ = id => document.getElementById(id);
const ciEq = (a,b) => (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase();
const getTournament = () => (data.tournaments||[]).find(t => String(t.id)===String(tid)) || null;
const getMatch = () => { const t=getTournament(); return t ? (t.matches||[]).find(m=>String(m.id)===String(mid))||null : null; };
const isLocked = m => !!(m && m.startTime && Date.now() >= new Date(m.startTime).getTime());

function timeMatch(p,a){
  const parse = s => { const m=(s||'').match(/^(\d{1,2}):(\d{2})$/); return m ? +m[1]*60 + +m[2] : null; };
  const ps=parse(p), as=parse(a);
  return ps!==null && as!==null && Math.abs(ps-as)<=60;
}
function fieldMatch(key,pv,av){
  if(!av || !pv) return false;
  if(key==='ekan_maali_aika') return timeMatch(pv,av);
  return ciEq(pv,av);
}
function calcMatchPts(t, matchId, player){
  const pr = ((t.predictions||{})[matchId]||{})[player]||{};
  const ac = (t.actuals||{})[matchId]||{};
  let s=0;
  FIELDS.forEach(f=>{ if(ac[f.key]!=null && ac[f.key]!=='' && fieldMatch(f.key, pr[f.key]||'', ac[f.key])) s++; });
  return s;
}
function calcTotals(t){
  const tot={}; PLAYERS.forEach(p=>tot[p]=0);
  (t.matches||[]).forEach(m => PLAYERS.forEach(p => { tot[p] += calcMatchPts(t, m.id, p); }));
  if(t.topThreePrediction){
    const aT = t.actualTopThree||[];
    PLAYERS.forEach(p => {
      const pr = t.topThreePrediction[p]||[];
      let pts=0; pr.forEach((team,i) => { if(team && aT[i] && ciEq(team,aT[i])) pts+=2; });
      tot[p] += pts;
    });
  }
  return tot;
}

// Tallenna/palauta valinnat
function saveSelections(){ try{ localStorage.setItem('tv_sel', JSON.stringify({t:tid,m:mid})); }catch(e){} }
function restoreSelections(){
  try{
    const s = JSON.parse(localStorage.getItem('tv_sel')||'{}');
    if(!tid && s.t) tid=s.t;
    if(!mid && s.m) mid=s.m;
  }catch(e){}
}

// ============================
// STATUS BAR
// ============================
function showStatus(msg, color){
  const el=$('fb-status'); if(!el) return;
  el.textContent=msg; el.style.background=color||'#f97316'; el.style.color='#fff'; el.style.opacity='1';
}
function hideStatus(){ setTimeout(()=>{ const el=$('fb-status'); if(el) el.style.opacity='0'; }, 1800); }

// ============================
// FIREBASE
// ============================
async function save(){
  data.selectedTournamentId = tid;
  data.selectedMatchId = mid;
  try{ localStorage.setItem('tv_bkp', JSON.stringify(data)); }catch(e){}
  if(isSaving){ saveQueued=true; return; }
  isSaving=true; showStatus('üíæ Tallennetaan‚Ä¶','#f97316');
  try{
    await setDoc(DATA_DOC, {json: JSON.stringify(data)});
    showStatus('‚úÖ Tallennettu','#22c55e'); hideStatus();
  }catch(e){ showStatus('‚ùå Tallennus ep√§onnistui','#dc2626'); }
  isSaving=false;
  if(saveQueued){ saveQueued=false; save(); }
}

async function loadData(){
  showStatus('‚è≥ Ladataan‚Ä¶','#6366f1');
  try{
    const [snap, pinSnap] = await Promise.all([getDoc(DATA_DOC), getDoc(PINS_DOC)]);
    if(snap.exists()){ data=JSON.parse(snap.data().json); }
    if(pinSnap.exists()){ pins=pinSnap.data().pins||{}; }
  }catch(e){
    const bkp=localStorage.getItem('tv_bkp');
    if(bkp) try{ data=JSON.parse(bkp); }catch(e2){}
    showStatus('‚ö†Ô∏è Yhteysvirhe ‚Äì paikallinen data','#f59e0b');
  }
  if(!data.tournaments) data.tournaments=[];
  // Palauta valinnat datasta tai localStoragesta
  if(!tid) tid = data.selectedTournamentId||null;
  if(!mid) mid = data.selectedMatchId||null;
  restoreSelections();
  hideStatus();
  render();

  // Kuuntele muutoksia ‚Äì √ÑL√Ñ nollaa k√§ytt√§j√§n valintoja
  onSnapshot(DATA_DOC, snap => {
    if(!snap.exists() || isSaving) return;
    try{
      const prevTid=tid, prevMid=mid;
      data = JSON.parse(snap.data().json);
      if(!data.tournaments) data.tournaments=[];
      // S√§ilyt√§ valinnat jos ne ovat edelleen valideja
      const tOk = prevTid && data.tournaments.find(t=>String(t.id)===String(prevTid));
      if(tOk){
        tid=prevTid;
        const tObj=data.tournaments.find(t=>String(t.id)===String(prevTid));
        const mOk = prevMid && (tObj.matches||[]).find(m=>String(m.id)===String(prevMid));
        mid = mOk ? prevMid : null;
      } else {
        tid=data.selectedTournamentId||null;
        mid=data.selectedMatchId||null;
      }
      render();
    }catch(e){}
  });
}

// ============================
// COUNTDOWN ‚Äì ei ikuista silmukkaa
// ============================
function stopCountdown(){
  if(cdTimer){ clearInterval(cdTimer); cdTimer=null; }
  cdRunning=false;
  const el=$('countdown'); if(el) el.textContent='';
}

function startCountdown(match){
  stopCountdown();
  if(!match || !match.startTime) return;
  const target = new Date(match.startTime).getTime();
  if(Date.now() >= target) return; // Jo lukittu, ei tarvita countdownia

  cdRunning=true;
  const el=$('countdown');
  const tick = () => {
    const diff = target - Date.now();
    if(diff <= 0){
      stopCountdown();
      // P√§ivit√§ vain banneri ja veikkausalue, EI koko renderAll
      renderMatchBanner(match);
      renderPredictions();
      return;
    }
    const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
    if(el) el.textContent = '‚è≥ Veikkauksia voi muuttaa viel√§: '+(h>0?h+'t ':'')+m+'min '+s+'s';
  };
  tick();
  cdTimer = setInterval(tick, 1000);
}

// ============================
// WIDGET (kentt√§)
// ============================
function widget(key, value, dataset, disabled, isAct){
  const ds = isAct ? `data-act="${key}"` : `data-pred="${dataset}"`;
  const dis = disabled ? 'disabled' : '';
  if(key==='lopputulos'){
    const p=(value||'').split('-'), h=p[0]?p[0].trim():'', a=p[1]?p[1].trim():'';
    const hAttr = isAct ? 'data-act-home' : `data-pred-home="${dataset}"`;
    const aAttr = isAct ? 'data-act-away' : `data-pred-away="${dataset}"`;
    return `<div class="score-combo"><input type="number" inputmode="numeric" ${hAttr} value="${h}" placeholder="0" ${dis}/><span class="dash">-</span><input type="number" inputmode="numeric" ${aAttr} value="${a}" placeholder="0" ${dis}/></div>`;
  }
  if(key==='ekan_maali_aika'){
    const p=(value||'').split(':'), m=p[0]?p[0].trim():'', s=p[1]?p[1].trim():'';
    const mAttr = isAct ? 'data-act-min' : `data-pred-min="${dataset}"`;
    const sAttr = isAct ? 'data-act-sec' : `data-pred-sec="${dataset}"`;
    return `<div class="time-combo"><input type="number" inputmode="numeric" ${mAttr} value="${m}" placeholder="00" ${dis}/><span class="colon">:</span><input type="number" inputmode="numeric" ${sAttr} value="${s}" placeholder="00" ${dis}/></div>`;
  }
  const makeSelect = opts => `<select ${ds} ${dis}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o||'‚Äî'}</option>`).join('')}</select>`;
  if(key==='ekan_maalintekija') return makeSelect(['', ...GOAL_SCORERS]);
  if(key==='ekan_jahyn_saaja') return makeSelect(['', ...PENALTY_TAKERS]);
  if(key==='ekan_jahyn_syy') return makeSelect(['', ...PENALTY_REASONS]);
  if(ONE_X_TWO.has(key)) return makeSelect(['','1','X','2']);
  if(KYLLA_EI.has(key)) return makeSelect(['','Kyll√§','Ei']);
  if(NUMBER_K.has(key)) return `<input type="number" inputmode="numeric" ${ds} value="${value||''}" placeholder="0" ${dis}/>`;
  return `<input type="text" ${ds} value="${value||''}" placeholder="‚Ä¶" ${dis}/>`;
}

// ============================
// PRED CARD HTML
// ============================
function predCardHTML(t, match, player, showColors){
  const pred=((t.predictions||{})[match.id]||{})[player]||{};
  const actual=(t.actuals||{})[match.id]||{};
  const locked=isLocked(match);
  const canEdit = (player===currentUser && !locked);
  const pts = calcMatchPts(t, match.id, player);
  const rows = FIELDS.map(f=>{
    const v=pred[f.key]||'', av=actual[f.key]||'';
    const ok = showColors && av!=='' && fieldMatch(f.key,v,av);
    const bad = showColors && av!=='' && v!=='' && !ok;
    const w = widget(f.key, v, player+':'+f.key, !canEdit, false);
    return `<div class="kv-row ${ok?'correct':''} ${bad?'incorrect':''}">`+
           `<div class="kv-label">${f.label}</div>${w}</div>`;
  }).join('');
  return `<div class="person-card"><div class="card-head">`+
         `<div class="person-title">${player===ADMIN?'üëë ':''}${player}</div>`+
         `${showColors?`<div class="pts-badge">${pts} p</div>`:''}</div>`+
         `<div class="kv">${rows}</div></div>`;
}

// ============================
// ATTACH LISTENERS ‚Äì veikkaukset
// ============================
function attachPredListeners(el, t, matchId){
  const handle = e => {
    if(e.target.dataset.predHome!==undefined || e.target.dataset.predAway!==undefined){
      const par=e.target.closest('.score-combo'); if(!par) return;
      const hi=par.querySelector('[data-pred-home]'), ai=par.querySelector('[data-pred-away]');
      if(!hi || hi.dataset.predHome===undefined) return;
      const pl=hi.dataset.predHome.split(':')[0];
      t.predictions[matchId]=t.predictions[matchId]||{};
      t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
      t.predictions[matchId][pl]['lopputulos']=(hi.value&&ai.value)?(hi.value+'-'+ai.value):'';
      return;
    }
    if(e.target.dataset.predMin!==undefined || e.target.dataset.predSec!==undefined){
      const par=e.target.closest('.time-combo'); if(!par) return;
      const mi=par.querySelector('[data-pred-min]'), si=par.querySelector('[data-pred-sec]');
      if(!mi || mi.dataset.predMin===undefined) return;
      const pl=mi.dataset.predMin.split(':')[0];
      t.predictions[matchId]=t.predictions[matchId]||{};
      t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
      t.predictions[matchId][pl]['ekan_maali_aika']=(mi.value&&si.value)?(mi.value+':'+si.value):'';
      return;
    }
    const ds=e.target.dataset.pred; if(!ds) return;
    const [pl,key]=ds.split(':');
    t.predictions[matchId]=t.predictions[matchId]||{};
    t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
    t.predictions[matchId][pl][key]=e.target.value;
  };
  el.querySelectorAll('input[data-pred],input[data-pred-home],input[data-pred-away],input[data-pred-min],input[data-pred-sec]')
    .forEach(i=>{ i.addEventListener('input',handle); i.addEventListener('blur',()=>{ save(); renderScoreboard(); }); });
  el.querySelectorAll('select[data-pred]')
    .forEach(s=>{ s.addEventListener('change',e=>{ handle(e); save(); renderScoreboard(); }); });
}

// ============================
// ATTACH LISTENERS ‚Äì faktat
// ============================
function attachActualListeners(el, t, matchId){
  const handle = e => {
    if(e.target.dataset.actHome!==undefined || e.target.dataset.actAway!==undefined){
      const par=e.target.closest('.score-combo'); if(!par) return;
      const hi=par.querySelector('[data-act-home]'), ai=par.querySelector('[data-act-away]');
      t.actuals[matchId]=t.actuals[matchId]||{};
      t.actuals[matchId]['lopputulos']=(hi.value&&ai.value)?(hi.value+'-'+ai.value):'';
      renderScoreboard(); save(); return;
    }
    if(e.target.dataset.actMin!==undefined || e.target.dataset.actSec!==undefined){
      const par=e.target.closest('.time-combo'); if(!par) return;
      const mi=par.querySelector('[data-act-min]'), si=par.querySelector('[data-act-sec]');
      t.actuals[matchId]=t.actuals[matchId]||{};
      t.actuals[matchId]['ekan_maali_aika']=(mi.value&&si.value)?(mi.value+':'+si.value):'';
      renderScoreboard(); save(); return;
    }
    const key=e.target.dataset.act; if(!key) return;
    t.actuals[matchId]=t.actuals[matchId]||{};
    t.actuals[matchId][key]=e.target.value;
    renderScoreboard(); save();
  };
  el.querySelectorAll('input[data-act],input[data-act-home],input[data-act-away],input[data-act-min],input[data-act-sec]')
    .forEach(i=>i.addEventListener('input',handle));
  el.querySelectorAll('select[data-act]')
    .forEach(s=>s.addEventListener('change',handle));
}

// ============================
// RENDER: BANNERI
// ============================
function renderMatchBanner(match){
  const el=$('matchLockBanner'); if(!el) return;
  if(!match){ el.innerHTML=''; return; }
  if(isLocked(match)){
    el.innerHTML='<div class="lock-banner">üîí Peli alkanut ‚Äì veikkaukset lukittu ‚Äì tulokset n√§kyviss√§</div>';
  } else {
    const ts=match.startTime?new Date(match.startTime).toLocaleString('fi-FI',{weekday:'short',day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'}):'';
    el.innerHTML='<div class="open-banner">‚úÖ Veikkaukset auki'+(ts?' ‚Äì lukittuu '+ts:'')+'</div>';
  }
}

// ============================
// RENDER: VEIKKAUKSET
// ============================
function renderPredictions(){
  const el=$('predictionsArea'); if(!el) return;
  const t=getTournament(), match=getMatch();
  if(!t || !match){ el.innerHTML='<p class="muted">Valitse ottelu.</p>'; return; }

  const locked=isLocked(match);
  t.predictions=t.predictions||{};
  t.actuals=t.actuals||{};

  if(currentUser===ADMIN){
    if(!locked){
      el.innerHTML=predCardHTML(t,match,ADMIN,false);
    } else if(viewMode==='table'){
      const actual=(t.actuals||{})[match.id]||{};
      let thead='<tr><th class="sticky-top sticky-left sticky-corner">Kohde</th>'+
        PLAYERS.map(p=>'<th class="sticky-top">'+(p===ADMIN?'üëë':'')+' '+p+'</th>').join('')+'</tr>';
      let tbody=FIELDS.map(f=>{
        let row='<tr><th class="sticky-left">'+f.label+'</th>';
        row+=PLAYERS.map(p=>{
          const pv=((t.predictions[match.id]||{})[p]||{})[f.key]||'';
          const av=actual[f.key]||'';
          const ok=av!==''&&fieldMatch(f.key,pv,av);
          const bad=av!==''&&pv!==''&&!ok;
          return '<td class="'+(ok?'correct':bad?'incorrect':'')+'">'+widget(f.key,pv,p+':'+f.key,true,false)+'</td>';
        }).join('');
        return row+'</tr>';
      }).join('');
      el.innerHTML='<div class="table-wrap"><table><thead>'+thead+'</thead><tbody>'+tbody+'</tbody></table></div>';
    } else {
      el.innerHTML=PLAYERS.map(p=>predCardHTML(t,match,p,true)).join('');
    }
  } else {
    el.innerHTML=predCardHTML(t,match,currentUser,locked);
  }
  attachPredListeners(el,t,match.id);
}

// ============================
// RENDER: FAKTAT
// ============================
function renderActuals(){
  const el=$('actualsArea'); if(!el) return;
  const t=getTournament(), match=getMatch();
  if(!t || !match){ el.innerHTML='<p class="muted">Valitse ottelu.</p>'; return; }
  t.actuals=t.actuals||{};
  t.actuals[match.id]=t.actuals[match.id]||{};
  const act=t.actuals[match.id];
  const isAdmin=currentUser===ADMIN;
  const rows=FIELDS.map(f=>'<div class="kv-row"><div class="kv-label">'+f.label+'</div>'+widget(f.key,act[f.key]||'',f.key,!isAdmin,true)+'</div>').join('');
  el.innerHTML='<div class="person-card actuals-card"><div class="card-head"><div class="person-title">Faktat</div>'+
    '<div class="pill">'+(isAdmin?'Muokattavissa':'Vain luku')+'</div></div><div class="kv">'+rows+'</div></div>';
  if(isAdmin) attachActualListeners(el,t,match.id);
}

// ============================
// RENDER: SCOREBOARD
// ============================
function renderScoreboard(){
  const el=$('scoreboard'); if(!el) return;
  const t=getTournament();
  if(!t){ el.innerHTML='<p class="muted">Valitse turnaus.</p>'; return; }
  const totals=calcTotals(t);
  const sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const uPts=[...new Set(sorted.map(x=>x[1]))].sort((a,b)=>b-a);
  const icon=pts=>{ const r=uPts.indexOf(pts)+1; return r===1?'ü•á':r===2?'ü•à':r===3?'ü•â':'üí©'; };
  el.innerHTML='<div class="score-grid">'+sorted.map(([n,pts])=>
    `<div class="score-card"><div class="name">${icon(pts)} ${n}</div><div class="pts">${pts} p</div></div>`
  ).join('')+'</div>';
}

// ============================
// RENDER: PLAYER STATUS (admin)
// ============================
function renderPlayerStatus(){
  const el=$('playerStatusArea'); if(!el) return;
  const t=getTournament(), match=getMatch();
  if(!t || !match || currentUser!==ADMIN){ el.innerHTML=''; return; }
  const preds=(t.predictions||{})[match.id]||{};
  const locked=isLocked(match);
  el.innerHTML='<div class="player-status-grid">'+PLAYERS.map(p=>{
    const voted=preds[p]&&Object.values(preds[p]).some(v=>v!=='');
    const cls=locked?'done':voted?'voted':'not-voted';
    return `<div class="player-status-card ${cls}">${voted?'‚úÖ':'‚ùå'} ${p}</div>`;
  }).join('')+'</div>';
}

// ============================
// RENDER: KOLMEN K√ÑRKI
// ============================
function isTop3Locked(t){
  if(!t||!(t.matches||[]).length) return false;
  const first=[...t.matches].sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0))[0];
  return isLocked(first);
}

function renderTopThree(){
  const wrap=$('topThreeArea'), t=getTournament();
  if(!t){ wrap.innerHTML='<p class="muted">Luo ensin turnaus.</p>'; return; }
  t.topThreePrediction=t.topThreePrediction||{}; t.actualTopThree=t.actualTopThree||['','',''];
  const TEAMS=['KANADA','SUOMI','USA','RUOTSI','TSEKKI','RANSKA','SVEITSI','ITALIA','SLOVAKIA','TANSKA','SAKSA','LATVIA','NORJA','ISO-BRITANNIA','KAZAKSTAN','IT√ÑVALTA','SLOVENIA','PUOLA','UKRAINA','VIRO','LIETTUA'];
  const tOpts='<option value=""></option>'+TEAMS.map(tm=>`<option value="${tm}">${tm}</option>`).join('');
  const isAdmin=currentUser===ADMIN;
  const locked=isTop3Locked(t);
  const showResults=t.finished;
  const uPred=t.topThreePrediction[currentUser]||['','',''];
  const aT3=t.actualTopThree||[];

  let banner='';
  if(!(t.matches||[]).length){
    banner='<p class="muted" style="margin-bottom:8px">Veikkaus avautuu kun ensimm√§inen ottelu luodaan.</p>';
  } else if(locked && !showResults){
    banner='<div class="lock-banner" style="margin-bottom:8px">üîí Kolmen k√§rki lukittu ‚Äì tulokset n√§kyv√§t turnauksen j√§lkeen</div>';
  } else if(!locked){
    const first=[...t.matches].sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0))[0];
    const ts=first.startTime?new Date(first.startTime).toLocaleString('fi-FI',{weekday:'short',day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'}):'';
    banner='<div class="open-banner" style="margin-bottom:8px">‚úÖ Veikkaukset auki'+(ts?' ‚Äì lukittuu '+ts:'')+'</div>';
  }

  let adminStatus='';
  if(isAdmin){
    adminStatus='<div style="margin-bottom:10px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">üë• Kuka on veikannut?</div><div class="player-status-grid">'+
    PLAYERS.map(p=>{
      const voted=(t.topThreePrediction[p]||[]).some(v=>v!=='');
      return `<div class="player-status-card ${voted?'voted':'not-voted'}">${voted?'‚úÖ':'‚ùå'} ${p}</div>`;
    }).join('')+'</div></div>';
  }

  let html=banner+adminStatus+'<div class="t3-grid">';
  if(isAdmin && locked){
    html+='<div class="t3-card"><div class="t3-title">‚úÖ Lis√§√§ todellinen j√§rjestys</div>'+
      [0,1,2].map(i=>'<div class="t3-row"><label style="font-size:12px;color:var(--muted);margin-bottom:2px">'+(i+1)+'. sija</label><select data-t3a="'+i+'">'+tOpts+'</select></div>').join('')+'</div>';
  }

  if((t.matches||[]).length){
    if(showResults){
      PLAYERS.forEach(p=>{
        const pPred=t.topThreePrediction[p]||['','',''];
        const rows=[0,1,2].map(i=>{
          const v=pPred[i]||'', av=aT3[i]||'';
          const ok=av&&ciEq(v,av), bad=av&&v&&!ok;
          return '<div class="kv-row '+(ok?'correct':bad?'incorrect':'')+'"><div class="kv-label">'+(i+1)+'. sija</div><div style="padding:8px;font-weight:600">'+(v||'‚Äî')+'</div></div>';
        }).join('');
        html+='<div class="t3-card"><div class="t3-title">'+(p===ADMIN?'üëë ':'')+p+'</div>'+rows+'</div>';
      });
    } else if(locked){
      html+='<div class="t3-card"><div class="t3-title">Oma veikkaus üîí</div><p class="muted" style="font-size:13px">Veikkauksesi on tallennettu. Tulokset n√§kyv√§t turnauksen j√§lkeen.</p></div>';
    } else {
      html+='<div class="t3-card"><div class="t3-title">Oma veikkaus</div>'+
        [0,1,2].map(i=>'<div class="t3-row"><label style="font-size:12px;color:var(--muted);margin-bottom:2px">'+(i+1)+'. sija</label><select data-t3m="'+i+'">'+tOpts+'</select></div>').join('')+'</div>';
    }
  }
  html+='</div>';
  wrap.innerHTML=html;

  if(isAdmin && locked){
    [0,1,2].forEach(i=>{ const s=wrap.querySelector('[data-t3a="'+i+'"]'); if(s&&aT3[i]) s.value=aT3[i]; });
    wrap.querySelectorAll('[data-t3a]').forEach(inp=>inp.addEventListener('change',e=>{
      t.actualTopThree[+e.target.dataset.t3a]=e.target.value; renderScoreboard(); save();
    }));
  }
  if(!locked){
    [0,1,2].forEach(i=>{ const s=wrap.querySelector('[data-t3m="'+i+'"]'); if(s&&uPred[i]) s.value=uPred[i]; });
    wrap.querySelectorAll('[data-t3m]').forEach(inp=>inp.addEventListener('change',e=>{
      const idx=+e.target.dataset.t3m;
      t.topThreePrediction[currentUser]=t.topThreePrediction[currentUser]||['','',''];
      t.topThreePrediction[currentUser][idx]=e.target.value;
      renderScoreboard(); save();
    }));
  }
}

// ============================
// RENDER: TURNAUKSEN STATUS
// ============================
function renderTournamentStatus(){
  const t=getTournament();
  const fa=$('finishTournamentArea'), badge=$('tournamentFinishedBadge'), del=$('deleteTournamentArea'), sc=$('statsCard');
  if(!t || currentUser!==ADMIN){
    if(fa) fa.style.display='none';
    if(badge) badge.style.display='none';
    if(del) del.style.display='none';
    if(sc) sc.style.display='none';
    return;
  }
  if(del) del.style.display='';
  if(t.finished){
    if(fa) fa.style.display='none';
    if(badge) badge.style.display='';
    if(sc) sc.style.display='';
    renderStats();
  } else {
    if(fa) fa.style.display='';
    if(badge) badge.style.display='none';
    if(sc) sc.style.display='none';
  }
}

// ============================
// RENDER: STATS
// ============================
function renderStats(){
  const t=getTournament(); if(!t) return;
  const el=$('statsArea'); if(!el) return;
  const totals=calcTotals(t), sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const medals=['ü•á','ü•à','ü•â'];
  let best=null;
  (t.matches||[]).forEach(m=>PLAYERS.forEach(p=>{ const pts=calcMatchPts(t,m.id,p); if(!best||pts>best.pts) best={player:p,matchName:m.name,pts}; }));
  const mW=(t.matches||[]).map(m=>{
    let b=null;
    PLAYERS.forEach(p=>{ const pts=calcMatchPts(t,m.id,p); if(!b||pts>b.pts) b={player:p,pts}; else if(pts===b.pts) b.player+=' & '+p; });
    return {matchName:m.name,...b};
  });
  let html='<div style="margin-bottom:14px"><div style="font-weight:700;margin-bottom:8px">ü•á Lopputulokset</div><div class="score-grid">'+
    sorted.map(([n,pts],i)=>'<div class="score-card"><div class="name">'+(medals[i]||'')+ ' '+n+'</div><div class="pts">'+pts+' p</div></div>').join('')+'</div></div><div class="separator"></div>';
  if(best) html+='<div style="margin-bottom:14px"><div style="font-weight:700;margin-bottom:6px">‚≠ê Paras suoritus</div><div style="background:var(--card);border:2px solid var(--primary);border-radius:10px;padding:10px"><div style="font-size:18px;font-weight:800">'+best.player+'</div><div style="color:var(--muted);font-size:14px">'+best.matchName+'</div><div style="font-size:24px;font-weight:800;color:var(--primary)">'+best.pts+' p</div></div></div><div class="separator"></div>';
  html+='<div><div style="font-weight:700;margin-bottom:8px">üèÖ Otteluvoittajat</div><div style="display:grid;gap:6px">'+
    mW.map(w=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--card);border:1px solid var(--border);border-radius:8px"><div style="font-size:13px;color:var(--muted)">'+w.matchName+'</div><div><span style="font-weight:700">'+w.player+'</span> <span class="pts-badge">'+w.pts+' p</span></div></div>').join('')+'</div></div>';
  el.innerHTML=html;
}

// ============================
// RENDER: PIN HALLINTA
// ============================
function renderPinManage(){
  const el=$('pinManageArea'); if(!el) return;
  el.innerHTML=PLAYERS.map(p=>{
    const hasPin=pins[p]?'‚úÖ PIN asetettu':'‚ùå Ei PINi√§';
    const col=pins[p]?'#166534':'#991b1b';
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);gap:8px">'+
      '<div><div style="font-weight:700">'+(p===ADMIN?'üëë ':'')+p+'</div><div style="font-size:12px;color:'+col+'">'+hasPin+'</div></div>'+
      '<div style="display:flex;gap:6px;align-items:center">'+
      '<input type="password" inputmode="numeric" maxlength="4" placeholder="1234" id="pin_'+p+'" style="width:80px;padding:8px;font-size:16px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)" />'+
      '<button class="btn small" data-pin-player="' + p + '">Tallenna</button></div></div>';
  }).join('');
}

// PIN save via event delegation (called from renderPinManage)
document.addEventListener('click', async e => {
  const btn = e.target.closest('[data-pin-player]');
  if(!btn) return;
  window._savePin(btn.dataset.pinPlayer);
});

window._savePin = async function(player){
  const input=$('pin_'+player); if(!input) return;
  const val=input.value.trim();
  if(!/^\d{4}$/.test(val)){ alert('PIN-koodin pit√§√§ olla 4 numeroa!'); return; }
  pins[player]=val;
  try{ await setDoc(PINS_DOC,{pins}); input.value=''; renderPinManage(); showStatus('‚úÖ '+player+':n PIN tallennettu','#22c55e'); hideStatus(); }
  catch(e){ alert('Tallennus ep√§onnistui: '+e.message); }
};

// ============================
// RENDER: KAIKKI KERRALLA
// ============================
function render(){
  renderTournamentSelects();
  renderTopThree();
  renderScoreboard();
  renderMatchArea();
  renderTournamentStatus();
  if(currentUser===ADMIN) renderPinManage();
}

function renderTournamentSelects(){
  // Turnausvalinta
  const tSel=$('tournamentSelect');
  if(tSel){
    tSel.innerHTML='<option value="">Valitse turnaus‚Ä¶</option>'+
      (data.tournaments||[]).map(t=>'<option value="'+t.id+'" '+(String(t.id)===String(tid)?'selected':'')+'>'+t.name+(t.finished?' ‚úÖ':'')+'</option>').join('');
    tSel.onchange=e=>{ tid=e.target.value||null; mid=null; saveSelections(); save(); render(); };
  }
  // Otteluvalinta
  const mSel=$('matchSelect'), t=getTournament();
  if(!mSel) return;
  if(!t){ mSel.innerHTML='<option value="">‚Äî</option>'; mSel.disabled=true; mid=null; return; }
  mSel.disabled=false;
  // Auto-valitse jos vain yksi ottelu
  if(!mid && (t.matches||[]).length===1) mid=String(t.matches[0].id);
  mSel.innerHTML='<option value="">Valitse ottelu‚Ä¶</option>'+
    (t.matches||[]).map(m=>{
      const lk=isLocked(m)?'üîí ':'';
      const ts=m.startTime?' ('+new Date(m.startTime).toLocaleString('fi-FI',{day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'})+')':'';
      return '<option value="'+m.id+'" '+(String(m.id)===String(mid)?'selected':'')+'>'+lk+m.name+ts+'</option>';
    }).join('');
  mSel.onchange=e=>{ mid=e.target.value||null; saveSelections(); renderMatchArea(); };
  // Poista ottelu -nappi
  const da=$('deleteMatchArea');
  if(da) da.style.display=(currentUser===ADMIN&&mid)?'':'none';
}

function renderMatchArea(){
  const t=getTournament(), match=getMatch();
  renderMatchBanner(match);
  renderPlayerStatus();
  renderPredictions();
  renderActuals();
  // Countdown vain jos ei lukittu
  if(match && !isLocked(match)){
    startCountdown(match);
  } else {
    stopCountdown();
  }
}

// ============================
// KIRJAUTUMINEN + PIN
// ============================
let pinBuffer='', pendingName='';

function buildLogin(){
  const grid=$('playerGrid'); if(!grid) return;
  grid.innerHTML=PLAYERS.map(p=>'<button class="player-btn '+(p===ADMIN?'admin':'')+'" data-login-name="'+p+'">'+( p===ADMIN?'üëë ':'')+p+'</button>').join('');
  grid.querySelectorAll('[data-login-name]').forEach(btn=>btn.addEventListener('click',()=>window._selectName(btn.dataset.loginName)));
}

window._selectName=function(name){
  pendingName=name; pinBuffer='';
  $('loginStep1').style.display='none'; $('loginStep2').style.display='';
  $('loginName').textContent=name; $('pinError').textContent='';
  renderPinDots();
};
window._backToNames=function(){
  pendingName=''; pinBuffer='';
  $('loginStep1').style.display=''; $('loginStep2').style.display='none';
};

function renderPinDots(){
  const el=$('pinDots'); if(!el) return;
  el.innerHTML=[0,1,2,3].map(i=>'<div class="pin-dot '+(i<pinBuffer.length?'filled':'')+'"></div>').join('');
}

function handlePinKey(v){
  if(v==='clear'){ pinBuffer=''; renderPinDots(); $('pinError').textContent=''; return; }
  if(v==='back'){ pinBuffer=pinBuffer.slice(0,-1); renderPinDots(); $('pinError').textContent=''; return; }
  if(pinBuffer.length>=4) return;
  pinBuffer+=v; renderPinDots();
  if(pinBuffer.length===4) checkPin();
}

async function checkPin(){
  const name=pendingName;
  try{ const snap=await getDoc(PINS_DOC); if(snap.exists()) pins=snap.data().pins||{}; }catch(e){}
  const stored=pins[name];
  if(!stored){
    if(name===ADMIN){ doLogin(name); }
    else{ $('pinError').textContent='PIN-koodia ei ole asetettu. Pyyd√§ adminia.'; pinBuffer=''; renderPinDots(); }
    return;
  }
  if(pinBuffer===stored){ doLogin(name); }
  else{ $('pinError').textContent='V√§√§r√§ PIN-koodi.'; pinBuffer=''; renderPinDots(); }
}

function doLogin(name){
  currentUser=name;
  localStorage.setItem('tv_user',name);
  $('loginScreen').style.display='none'; $('appScreen').style.display='';
  $('currentUserBadge').textContent=(name===ADMIN?'üëë ':'')+name;
  const isAdmin=name===ADMIN;
  ['adminTournamentTools','adminMatchTools','adminStatusCard','adminPinTools'].forEach(id=>{
    const el=$(id); if(el) el.style.display=isAdmin?'':'none';
  });
  const ib=$('importBtn'); if(ib) ib.style.display=isAdmin?'':'none';
  const vt=$('viewTabs'); if(vt) vt.style.display=isAdmin?'':'none';
  loadData();
}

window._logout=function(){
  currentUser=null; localStorage.removeItem('tv_user');
  pinBuffer=''; pendingName='';
  stopCountdown();
  $('loginScreen').style.display=''; $('appScreen').style.display='none';
  $('loginStep1').style.display=''; $('loginStep2').style.display='none';
};

// ============================
// INIT
// ============================
buildLogin();
document.querySelectorAll('.pin-key').forEach(btn=>btn.addEventListener('click',()=>handlePinKey(btn.dataset.v)));

const savedUser=localStorage.getItem('tv_user');
if(savedUser && PLAYERS.includes(savedUser)) doLogin(savedUser);

// ============================
// NAPIT
// ============================
$('createTournament').onclick=()=>{
  const name=$('newTournamentName').value.trim(); if(!name){alert('Anna nimi');return;}
  const id=Date.now().toString();
  data.tournaments.push({id,name,matches:[],predictions:{},actuals:{},topThreePrediction:{},actualTopThree:[]});
  tid=id; mid=null; saveSelections(); save(); render(); $('newTournamentName').value='';
};
$('finishTournament').onclick=()=>{
  const t=getTournament(); if(!t) return;
  if(!confirm('P√§√§t√§ turnaus "'+t.name+'"?')) return;
  t.finished=true; save(); render();
};
$('deleteTournament').onclick=()=>{
  const t=getTournament(); if(!t) return;
  if(!confirm('Poistetaanko turnaus "'+t.name+'" ja kaikki sen data? T√§t√§ ei voi peruuttaa!')) return;
  data.tournaments=data.tournaments.filter(x=>String(x.id)!==String(tid));
  tid=null; mid=null; saveSelections(); save(); render();
};
$('createMatch').onclick=()=>{
  const t=getTournament(); if(!t){alert('Luo ensin turnaus');return;}
  const rawName=$('newMatchName').value.trim().toUpperCase(); if(!rawName){alert('Anna vastustajan nimi');return;}
  const name='SUOMI vs '+rawName;
  const tv=$('newMatchTime').value; if(!tv){alert('Aseta pelin alkuaika');return;}
  const id=Date.now().toString();
  t.matches.push({id,name,startTime:new Date(tv).toISOString()});
  t.predictions=t.predictions||{}; t.actuals=t.actuals||{};
  mid=id; saveSelections(); save(); render(); $('newMatchName').value=''; $('newMatchTime').value='';
};
$('deleteMatch').onclick=()=>{
  const t=getTournament(); if(!t||!mid) return;
  const match=getMatch(); if(!match) return;
  if(!confirm('Poistetaanko ottelu "'+match.name+'"? T√§t√§ ei voi peruuttaa!')) return;
  t.matches=t.matches.filter(m=>String(m.id)!==String(mid));
  delete (t.predictions||{})[mid]; delete (t.actuals||{})[mid];
  mid=null; saveSelections(); save(); render();
};
$('tabTable').onclick=()=>{ viewMode='table'; $('tabTable').classList.add('active'); $('tabCards').classList.remove('active'); renderPredictions(); };
$('tabCards').onclick=()=>{ viewMode='cards'; $('tabCards').classList.add('active'); $('tabTable').classList.remove('active'); renderPredictions(); };
$('refreshCheck').onclick=()=>{ save(); renderScoreboard(); renderPredictions(); };
$('saveTopThree').onclick=()=>save();
$('exportBtn').onclick=()=>{
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='turnausveikkaus_data.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
};
$('importBtn').onclick=()=>$('importFile').click();
$('importFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=async()=>{
    try{ const obj=JSON.parse(r.result); data=obj; tid=data.selectedTournamentId||null; mid=null; await save(); render(); alert('Tuotu!'); }
    catch(er){ alert('Virhe: '+er.message); }
  }; r.readAsText(f,'utf-8');
});

let t3v=localStorage.getItem('tv_top3')!=='0';
function applyT3(){ $('topThreeArea').style.display=t3v?'':'none'; $('saveTop3Row').style.display=t3v?'':'none'; $('toggleTop3').textContent=t3v?'Piilota':'N√§yt√§'; }
$('toggleTop3').onclick=()=>{ t3v=!t3v; localStorage.setItem('tv_top3',t3v?'1':'0'); applyT3(); }; applyT3();

let pinsVisible=localStorage.getItem('tv_pins')!=='0';
function applyPinsToggle(){ const a=$('pinManageArea'),b=$('togglePins'); if(!a||!b) return; a.style.display=pinsVisible?'':'none'; b.textContent=pinsVisible?'Piilota':'N√§yt√§'; }
const tpBtn=$('togglePins'); if(tpBtn) tpBtn.addEventListener('click',()=>{ pinsVisible=!pinsVisible; localStorage.setItem('tv_pins',pinsVisible?'1':'0'); applyPinsToggle(); }); applyPinsToggle();

</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.getElementById('screenshotTableBtn').addEventListener('click', async ()=>{
  try{
    const area=document.getElementById('predictionsArea');
    const target=area.querySelector('.table-wrap')||area;
    const canvas=await html2canvas(target,{scale:3,backgroundColor:null,useCORS:true,windowWidth:target.scrollWidth,windowHeight:target.scrollHeight});
    const link=document.createElement('a'); link.download='veikkaus.png'; link.href=canvas.toDataURL('image/png');
    document.body.appendChild(link); link.click(); link.remove();
  }catch(e){ alert('Kuvan luonti ep√§onnistui: '+(e&&e.message?e.message:e)); }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById('downloadPdfBtn').addEventListener('click', function(){
  if(!window.jspdf){ alert('Odota hetki ja yrit√§ uudelleen.'); return; }
  if(typeof getTournament==='undefined'||!getTournament()){ alert('Valitse ensin turnaus.'); return; }
  const t=getTournament();
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=170,ML=20,today=new Date().toLocaleDateString('fi-FI');
  let y=20;

  function chk(n){if(y+n>275){doc.addPage();y=20;}}
  function hr(){doc.setDrawColor(200);doc.line(ML,y,ML+W,y);y+=4;}
  function h1(s){chk(10);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.setTextColor(30,41,59);doc.text(s,ML,y);y+=7;doc.setTextColor(0);}
  function h2(s){chk(8);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(s,ML,y);y+=5;}
  function norm(s,ind){chk(6);doc.setFontSize(9);doc.setFont('helvetica','normal');doc.text(s,ML+(ind||0),y);y+=5.5;}
  function hdr(cols,ws){
    doc.setFillColor(30,41,59);doc.rect(ML,y-4,W,7,'F');
    doc.setTextColor(255);doc.setFontSize(9);doc.setFont('helvetica','bold');
    let x=ML;cols.forEach((c,i)=>{doc.text(String(c||''),x+2,y,{maxWidth:ws[i]-3});x+=ws[i];});
    y+=7;doc.setTextColor(0);doc.setDrawColor(200);doc.line(ML,y-0.5,ML+W,y-0.5);
  }
  function row(cols,ws,ri){
    chk(7);if(ri%2===0){doc.setFillColor(248,250,252);doc.rect(ML,y-4,W,7,'F');}
    doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(0);
    let x=ML;cols.forEach((c,i)=>{doc.text(String(c||''),x+2,y,{maxWidth:ws[i]-3});x+=ws[i];});
    y+=7;doc.setDrawColor(220);doc.line(ML,y-0.5,ML+W,y-0.5);
  }

  // PLAYERS & totals from app
  const PLIST=typeof PLAYERS!=='undefined'?PLAYERS:[];
  const tots=typeof calcTotals!=='undefined'?calcTotals(t):{};
  const sorted=[...PLIST].sort((a,b)=>(tots[b]||0)-(tots[a]||0));
  const aT3=t.actualTopThree||[];
  const fmatch=typeof fieldMatch!=='undefined'?fieldMatch:(k,p,a)=>(p||'').trim().toLowerCase()===(a||'').trim().toLowerCase();
  const cmPts=typeof calcMatchPts!=='undefined'?calcMatchPts:(t,mid,p)=>0;

  // FIELDS for stats
  const FLIST=[
    {key:'lopputulos',label:'Lopputulos'},{key:'ekan_maalintekija',label:'Ekan maalintekij√§'},
    {key:'ekan_maali_aika',label:'Ekan maalin tekoaika'},{key:'ekan_jahyn_saaja',label:'Ekan j√§√§hyn saaja'},
    {key:'ekan_jahyn_syy',label:'Ekan j√§√§hyn syy'},{key:'montako_jahyja',label:'Montako j√§√§hyd√§'},
    {key:'parempi_laukasu',label:'Kummalla parempi laukaus%'},{key:'parempi_alotus',label:'Kummalla parempi aloitus%'},
    {key:'parempi_torjunta',label:'Kummalla parempi torjunta%'},{key:'parempi_alivoima',label:'Kummalla parempi alivoima%'},
    {key:'parempi_ylivoima',label:'Kummalla parempi ylivoima%'},{key:'era1',label:'1. er√§ tulos'},
    {key:'era2',label:'2. er√§ tulos'},{key:'valmentaja_haasto',label:'Valmentaja haasto'},{key:'maali_tyhjiin',label:'Maali tyhjiin'}
  ];

  // --- HEADER ---
  doc.setFontSize(18);doc.setFont('helvetica','bold');doc.text('Turnausveikkaus - '+t.name,105,y,{align:'center'});y+=8;
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(120);doc.text('Luotu: '+today,105,y,{align:'center'});y+=6;doc.setTextColor(0);
  hr();

  // --- LOPPUSIJOITUKSET ---
  h1('LOPPUSIJOITUKSET');
  const med=['1.','2.','3.'];
  sorted.slice(0,3).forEach((p,i)=>{chk(8);doc.setFontSize(13-i*1.5);doc.setFont('helvetica','bold');doc.text(med[i]+'   '+p+'   '+tots[p]+' p',ML+5,y);y+=7;});
  y+=2;
  hdr(['Sija','Pelaaja','Pisteet'],[25,W-55,30]);
  let rank=1;
  sorted.forEach((p,i)=>{
    if(i>0&&tots[p]<tots[sorted[i-1]])rank=i+1;
    const suf=rank>3?' (poo)':'';
    row([rank+'.'+suf,p,tots[p]+' p'],[25,W-55,30],i);
  });
  y+=4;hr();

  // --- KOLMEN K√ÑRKI ---
  h1('KOLMEN K√ÑRKI ‚Äì VEIKKAUKSET');
  norm('Oikea j√§rjestys:',0);
  aT3.forEach((tm,i)=>norm((i+1)+'. sija: '+(tm||'‚Äî'),4));
  y+=2;norm('Pelaajien veikkaukset:',0);
  const cw=[35,35,35,35,W-140];
  hdr(['Pelaaja','1. sija','2. sija','3. sija','Pisteet'],cw);
  sorted.forEach((p,ri)=>{
    const pred=(t.topThreePrediction||{})[p]||['','',''];
    let pts=0;pred.forEach((v,i)=>{if(v&&aT3[i]&&v.trim().toUpperCase()===(aT3[i]||'').trim().toUpperCase())pts+=2;});
    row([p,pred[0]||'',pred[1]||'',pred[2]||'',pts+' p'],cw,ri);
  });
  y+=4;hr();

  // --- PISTEET OTTELUITTAIN ---
  h1('PISTEET OTTELUITTAIN');
  (t.matches||[]).forEach(m=>{
    const act=(t.actuals||{})[m.id]||{};
    const sc=act.lopputulos?' ('+act.lopputulos+')':'';
    h2(m.name+sc);
    const mp=sorted.map(p=>[p,cmPts(t,m.id,p)]).sort((a,b)=>b[1]-a[1]);
    mp.forEach(([p,pts])=>norm(p+'   '+pts+' p',4));
    y+=2;
  });
  hr();

  // --- PARHAAT SUORITUKSET ---
  h1('PARHAAT SUORITUKSET');
  let best=null;
  (t.matches||[]).forEach(m=>sorted.forEach(p=>{const pts=cmPts(t,m.id,p);if(!best||pts>best.pts)best={player:p,matchName:m.name,pts};}));
  if(best){
    norm('Paras yksitt√§inen suoritus',0);y+=1;chk(20);
    doc.setFillColor(255,247,237);doc.rect(ML,y-4,W,18,'F');
    doc.setDrawColor(249,115,22);doc.rect(ML,y-4,W,18,'S');
    doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(0);doc.text(best.player,ML+W/2,y+2,{align:'center'});
    doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(120);doc.text(best.matchName,ML+W/2,y+7,{align:'center'});
    doc.setFontSize(18);doc.setFont('helvetica','bold');doc.setTextColor(249,115,22);doc.text(best.pts+' p',ML+W/2,y+14,{align:'center'});
    doc.setTextColor(0);y+=22;
  }
  norm('Pelaajien parhaat ottelut:',0);
  sorted.forEach(p=>{
    let b=null;
    (t.matches||[]).forEach(m=>{const pts=cmPts(t,m.id,p);if(!b||pts>b.pts)b={matchName:m.name,pts};});
    norm(p+': '+(b?b.matchName:'‚Äî')+' ‚Äì '+(b?b.pts:0)+' p',4);
  });
  y+=4;hr();

  // --- TILASTOJA ---
  h1('TILASTOJA VASTAUKSISTA');
  const fs=FLIST.map(f=>{
    let ok=0,tot=0;
    (t.matches||[]).forEach(m=>{
      const av=((t.actuals||{})[m.id]||{})[f.key];
      if(av==null||av==='')return;
      sorted.forEach(p=>{tot++;const pv=(((t.predictions||{})[m.id]||{})[p]||{})[f.key]||'';if(fmatch(f.key,pv,av))ok++;});
    });
    return {label:f.label,ok,tot,pct:tot>0?Math.round(ok/tot*100):0};
  }).filter(f=>f.tot>0);
  if(fs.length){
    const easy=fs.reduce((a,b)=>a.pct>b.pct?a:b);
    const hard=fs.reduce((a,b)=>a.pct<b.pct?a:b);
    norm('Helpoin ja vaikein kohde:',0);
    norm('Helpoin: '+easy.label,4);norm(easy.ok+'/'+easy.tot+' oikein ('+easy.pct+'%)',8);
    norm('Vaikein: '+hard.label,4);norm(hard.ok+'/'+hard.tot+' oikein ('+hard.pct+'%)',8);
    y+=3;h2('OIKEAT VASTAUKSET ‚Äì MONTAKO ARVASI OIKEIN');
    hdr(['Kysymys','Oikein','%'],[W*0.6,W*0.2,W*0.2]);
    [...fs].sort((a,b)=>b.pct-a.pct).forEach((f,i)=>row([f.label,f.ok+'/'+f.tot,f.pct+'%'],[W*0.6,W*0.2,W*0.2],i));
  }

  // --- LOPPUSIVU ---
  doc.addPage();y=60;
  doc.setFontSize(11);doc.setFont('helvetica','normal');doc.setTextColor(120);
  doc.text('Kiitos osallistumisesta!',105,y,{align:'center'});y+=7;
  doc.text('Turnaus: '+t.name,105,y,{align:'center'});y+=12;doc.setTextColor(0);
  doc.setFontSize(14);doc.setFont('helvetica','bold');doc.text('TURNAUKSEN VOITTAJA',105,y,{align:'center'});y+=10;
  if(sorted.length){
    doc.setFontSize(28);doc.setFont('helvetica','bold');doc.setTextColor(249,115,22);
    doc.text(sorted[0],105,y,{align:'center'});y+=12;
    doc.setFontSize(14);doc.setFont('helvetica','normal');doc.setTextColor(120);
    doc.text(tots[sorted[0]]+' pistett√§',105,y,{align:'center'});y+=10;doc.setTextColor(0);
  }
  doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text('Kaikki sijoitukset:',ML,y);y+=7;
  rank=1;
  sorted.forEach((p,i)=>{
    if(i>0&&tots[p]<tots[sorted[i-1]])rank=i+1;
    const suf=rank>3?' (poo)':'';
    norm(rank+'. '+p+' - '+tots[p]+' p'+suf,0);
  });
  y+=8;
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(150);
  doc.text('* * *',105,y,{align:'center'});y+=6;
  doc.text('Turnausveikkaus - raportti '+today,105,y,{align:'center'});

  doc.save('turnausveikkaus_'+t.name.replace(/\s+/g,'_')+'.pdf');
});
</script>

<script>
  if("serviceWorker" in navigator){ window.addEventListener("load",()=>navigator.serviceWorker.register("sw.js")); }
</script>
</body>
</html>
