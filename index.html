<!DOCTYPE html>
<html lang="fi">
<head>
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>üèí Turnausveikkaus</title>
  <style>
    :root { --bg:#f7f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#f97316; --primary-hover:#ea580c; --border:#e5e7eb; --ok:#22c55e; --dark:#111827; }
    *{ box-sizing:border-box } html,body{ margin:0; padding:0 }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; line-height:1.5; padding:12px }
    @media (prefers-color-scheme: dark) {
      .score-card { background:#ffffff !important; color:#000000 !important; }
      .score-card .name { color:#000000 !important; font-weight:700; }
      :root { --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --border:#334155; --primary:#f97316; --dark:#f8fafc; }
      input, select { background:#1e293b !important; color:#ffffff !important; border-color:#475569 !important; }
      body { background:var(--bg); color:var(--text); }
      .card, .person-card, .t3-card, table th, table td { background:var(--card) !important; }
      .score-card { background:var(--card); border-color:var(--border); }
      .tabs .tab { background:var(--card); color:var(--text); }
    }
    h1{ text-align:center; margin:0 0 12px; font-size:22px } h2{ margin:0 0 10px; font-size:16px }
    .layout{ max-width:960px; margin:0 auto; display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:980px){ .layout{ grid-template-columns:360px 1fr } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .field{ margin-bottom:8px }
    label{ font-weight:600; font-size:14px; display:block; margin-bottom:6px }
    input[type="text"], input[type="number"], input[type="datetime-local"], select{ width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fff }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .btn{ display:inline-flex; justify-content:center; align-items:center; gap:8px; border:none; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; background:var(--primary); color:#fff; font-size:15px; }
    .btn.small{ padding:10px; font-size:14px; } .btn:disabled{ opacity:.6; cursor:not-allowed } .btn:hover:not(:disabled){ background:var(--primary-hover) }
    .btn.secondary{ background:#fff; color:#111; border:1px solid var(--border); }
    .btn.secondary:hover:not(:disabled){ background:#f3f4f6; }
    .btn.danger{ background:#dc2626; } .btn.danger:hover:not(:disabled){ background:#b91c1c; }
    .btn.green{ background:#22c55e; } .btn.green:hover:not(:disabled){ background:#16a34a; }
    .muted{ color:var(--muted); font-size:13px } .grid{ display:grid; gap:10px } .separator{ height:1px; background:var(--border); margin:12px 0 }
    .score-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px }
    .score-card{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center }
    .score-card .name{ font-weight:700; font-size:14px } .score-card .pts{ font-size:13px; color:#111 }
    .stack{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .tabs{ display:flex; border:1px solid var(--border); border-radius:10px; overflow:hidden }
    .tab{ flex:1; text-align:center; padding:10px; background:#fff; cursor:pointer; font-weight:700; color:var(--text); }
    .tab.active{ background:var(--dark); color:#fff !important; }
    .person-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff }
    .person-title{ font-weight:800; margin-bottom:8px }
    .kv{ display:grid; grid-template-columns:1fr; gap:6px }
    .kv-row{ display:grid; grid-template-columns:180px 1fr; gap:8px; align-items:center }
    @media(max-width:420px){ .kv-row{ grid-template-columns:140px 1fr } }
    .kv-label{ font-weight:600 }
    .kv-row.correct { background-color:#86efac !important; border-radius:8px; padding:4px 6px; }
    .kv-row.incorrect { background-color:#fca5a5 !important; border-radius:8px; padding:4px 6px; }
    .kv-row.correct input, .kv-row.correct select { background-color:#86efac !important; color:#000 !important; }
    .kv-row.incorrect input, .kv-row.incorrect select { background-color:#fca5a5 !important; color:#000 !important; }
    .kv-row.correct .kv-label, .kv-row.incorrect .kv-label { color:#000 !important; }
    .correct{ background-color:#86efac !important; }
    .incorrect{ background-color:#fca5a5 !important; }
    .score-combo{ display:flex; align-items:center; gap:6px } .score-combo input{ width:64px; text-align:center } .dash{ font-weight:800 }
    .time-combo{ display:flex; align-items:center; gap:6px; }
    .time-combo input{ width:64px; text-align:center; }
    .colon{ font-weight:800; }
    .pts-badge{ display:inline-block; background:#111827; color:#fff; font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px; }
    .card-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fafafa; font-size:12px }
    .t3-grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media(min-width:640px){ .t3-grid{ grid-template-columns:1fr 1fr; } }
    .t3-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .t3-title{ font-weight:800; margin-bottom:8px; font-size:15px; }
    .t3-row{ display:grid; grid-template-columns:1fr; gap:8px; align-items:center; margin-bottom:6px; }
    .table-wrap{ width:100%; overflow-x:auto; overflow-y:hidden; border-radius:10px; }
    .table-wrap table{ min-width:1000px; width:max-content; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    th,td{ border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; text-align:left; vertical-align:top; background:#fff }
    th:first-child,td:first-child{ border-left:1px solid var(--border) } tr:first-child th{ border-top:1px solid var(--border) }
    .sticky-top{ position:sticky; top:0; z-index:5; background:#fafafa }
    .sticky-left{ position:sticky; left:0; z-index:4; background:#fafafa }
    .sticky-corner{ z-index:6 }
    table td.correct{ background-color:#86efac !important; }
    table td.incorrect{ background-color:#fca5a5 !important; }
    .actuals-card.person-card{ padding:14px; }
    .actuals-card .kv-row{ grid-template-columns:200px 1fr; }
    @media(max-width:480px){ .actuals-card .kv-row{ grid-template-columns:150px 1fr; } }
    .actuals-card input, .actuals-card select{ padding:14px 16px; font-size:18px; border-radius:12px; }
    #loginScreen{ max-width:420px; margin:60px auto; text-align:center; }
    .pin-dot{ width:16px; height:16px; border-radius:50%; border:2px solid var(--border); background:transparent; transition:background 0.15s; }
    .pin-dot.filled{ background:var(--primary); border-color:var(--primary); }
    .pin-key{ padding:18px; font-size:20px; font-weight:700; border:2px solid var(--border); border-radius:14px; background:var(--card); color:var(--text); cursor:pointer; transition:all 0.1s; }
    .pin-key:hover{ border-color:var(--primary); background:var(--primary); color:#fff; }
    .pin-key:active{ transform:scale(0.93); }
    .player-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:24px; }
    .player-btn{ padding:20px; font-size:17px; font-weight:700; border:2px solid var(--border); border-radius:14px; background:var(--card); color:var(--text); cursor:pointer; transition:all 0.15s; }
    .player-btn:hover{ border-color:var(--primary); background:var(--primary); color:#fff; }
    .player-btn.admin{ border-color:#7c3aed; }
    .player-btn.admin:hover{ background:#7c3aed; border-color:#7c3aed; }
    #fb-status{ position:fixed; top:0; left:0; right:0; padding:6px; text-align:center; font-size:13px; font-weight:700; z-index:9999; transition:opacity 0.5s; opacity:0; pointer-events:none; }
    .player-status-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; }
    .player-status-card{ border-radius:10px; padding:8px 10px; text-align:center; font-weight:700; font-size:13px; border:2px solid; }
    .player-status-card.voted{ background:#dcfce7; border-color:#22c55e; color:#166534; }
    .player-status-card.not-voted{ background:#fee2e2; border-color:#dc2626; color:#991b1b; }
    .player-status-card.done{ background:#dbeafe; border-color:#3b82f6; color:#1e40af; }
    .lock-banner{ background:#dc2626; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; text-align:center; margin-bottom:10px; }
    .open-banner{ background:#22c55e; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; text-align:center; margin-bottom:10px; }
    #countdown{ font-size:13px; color:var(--muted); text-align:center; margin-bottom:8px; }
  </style>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
</head>
<body>

<div id="fb-status"></div>

<!-- KIRJAUTUMINEN -->
<div id="loginScreen">
  <div style="font-size:48px;margin-bottom:8px">üèí</div>
  <h1 style="font-size:26px;margin:0 0 6px">Turnausveikkaus</h1>

  <!-- Vaihe 1: valitse nimi -->
  <div id="loginStep1">
    <p class="muted">Valitse nimesi</p>
    <div class="player-grid" id="playerGrid"></div>
  </div>

  <!-- Vaihe 2: sy√∂t√§ PIN -->
  <div id="loginStep2" style="display:none;margin-top:16px">
    <p class="muted">Tervetuloa, <strong id="loginName"></strong>!</p>
    <p class="muted" style="margin-top:4px">Sy√∂t√§ PIN-koodi</p>
    <div style="display:flex;gap:8px;justify-content:center;margin:16px 0" id="pinDots"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:220px;margin:0 auto">
      <button class="pin-key" data-v="1">1</button>
      <button class="pin-key" data-v="2">2</button>
      <button class="pin-key" data-v="3">3</button>
      <button class="pin-key" data-v="4">4</button>
      <button class="pin-key" data-v="5">5</button>
      <button class="pin-key" data-v="6">6</button>
      <button class="pin-key" data-v="7">7</button>
      <button class="pin-key" data-v="8">8</button>
      <button class="pin-key" data-v="9">9</button>
      <button class="pin-key" data-v="back" style="background:#6b7280">‚Üê</button>
      <button class="pin-key" data-v="0">0</button>
      <button class="pin-key" data-v="clear" style="background:#6b7280">‚úï</button>
    </div>
    <p id="pinError" style="color:#dc2626;font-weight:700;margin-top:12px;min-height:20px"></p>
    <button class="btn small secondary" style="margin-top:8px" onclick="window._backToNames()">‚Üê Vaihda nimi</button>
  </div>
</div>

<!-- P√Ñ√ÑSOVELLUS -->
<div id="appScreen" style="display:none">
  <div style="max-width:960px;margin:0 auto 10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
    <h1 style="margin:0;font-size:20px">üèí Turnausveikkaus</h1>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="currentUserBadge" style="font-weight:700;font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:4px 12px;"></span>
      <button class="btn small secondary" onclick="window._logout()">Vaihda k√§ytt√§j√§</button>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <h2>Turnaus</h2>
      <div class="field">
        <label>Valitse turnaus</label>
        <select id="tournamentSelect"></select>
      </div>
      <div id="adminTournamentTools" style="display:none">
        <div class="field">
          <label>Luo uusi turnaus</label>
          <input id="newTournamentName" type="text" placeholder="Esim. MM 2026" />
        </div>
        <div class="field">
          <button id="createTournament" class="btn small" style="width:100%">Luo turnaus</button>
        </div>
        <div id="finishTournamentArea" style="display:none">
          <button id="finishTournament" class="btn small danger" style="width:100%;margin-top:6px">üèÅ P√§√§t√§ turnaus</button>
          <p class="muted" style="margin-top:4px;font-size:12px">Lukitsee turnauksen kokonaan.</p>
        </div>
        <div id="tournamentFinishedBadge" style="display:none">
          <div style="background:#22c55e;color:#fff;border-radius:10px;padding:10px;text-align:center;font-weight:700;margin-top:6px">‚úÖ Turnaus p√§√§ttynyt</div>
        </div>
        <div class="field" id="deleteTournamentArea" style="display:none;margin-top:6px">
          <button id="deleteTournament" class="btn small danger" style="width:100%">üóëÔ∏è Poista turnaus</button>
        </div>
      </div>

      <div class="separator"></div>
      <h2>Ottelut</h2>
      <div class="field">
        <label>Valitse ottelu</label>
        <select id="matchSelect"></select>
      </div>
      <div id="adminMatchTools" style="display:none">
        <div class="field">
          <label>Luo uusi ottelu</label>
          <input id="newMatchName" type="text" placeholder="Suomi vs Ruotsi" />
        </div>
        <div class="field">
          <label>Pelin alkuaika (veikkaukset lukittuvat)</label>
          <input id="newMatchTime" type="datetime-local" />
        </div>
        <div class="field">
          <button id="createMatch" class="btn small" style="width:100%">Luo ottelu</button>
        </div>
        <div class="field" id="deleteMatchArea" style="display:none;margin-top:4px">
          <button id="deleteMatch" class="btn small danger" style="width:100%">üóëÔ∏è Poista ottelu</button>
        </div>
      </div>

      <div class="separator"></div>
      <div class="stack" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Kolmen k√§rki</h2>
        <button id="toggleTop3" class="btn small secondary">Piilota</button>
      </div>
      <div id="topThreeArea"></div>
      <div id="saveTop3Row" class="stack" style="margin-top:8px">
        <button id="saveTopThree" class="btn small">Tallenna veikkaukset</button>
      </div>

      <div class="separator"></div>
      <h2>Data</h2>
      <div class="stack">
        <button id="exportBtn" class="btn small secondary">Vie JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="btn small secondary" style="display:none">Tuo JSON</button>
        <button id="screenshotTableBtn" class="btn small green">üì∑ Kuva</button>
        <button id="downloadPdfBtn" class="btn small" style="background:#7c3aed">üìÑ PDF</button>
      </div>
      <p class="muted" style="margin-top:6px">‚òÅÔ∏è Data tallentuu Firebase-pilveen</p>
      <div id="adminPinTools" style="display:none;margin-top:8px">
        <div class="separator"></div>
        <div class="stack" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">üîê PIN-koodit</h2>
          <button id="togglePins" class="btn small secondary">Piilota</button>
        </div>
        <div id="pinManageArea"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Yhteispisteet</h2>
        <div id="scoreboard"></div>
      </div>

      <div class="card" id="statsCard" style="display:none">
        <h2>üèÜ Turnauksen tilastot</h2>
        <div id="statsArea"></div>
      </div>

      <div class="card" id="adminStatusCard" style="display:none">
        <h2>üë• Kuka on veikannut?</h2>
        <div id="playerStatusArea"></div>
      </div>

      <div class="card">
        <div class="stack" style="justify-content:space-between;margin-bottom:8px">
          <h2 style="margin:0">Ottelun veikkaukset</h2>
          <div class="tabs" id="viewTabs" style="display:none">
            <div id="tabTable" class="tab">Taulukko</div>
            <div id="tabCards" class="tab active">Kortit</div>
          </div>
        </div>
        <div id="matchLockBanner"></div>
        <div id="countdown"></div>
        <div id="predictionsArea"><p class="muted">Valitse turnaus ja ottelu.</p></div>
      </div>

      <div class="card">
        <h2>Ottelun tulos (faktat)</h2>
        <div id="actualsArea"><p class="muted">Valitse ottelu.</p></div>
        <div style="margin-top:10px;display:flex;justify-content:flex-end">
          <button id="refreshCheck" class="btn small">P√§ivit√§ & tarkasta</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAsUte6gqukH14_80R6QE-sYR8d_nnaAFA",
  authDomain: "turnausveikkaus.firebaseapp.com",
  projectId: "turnausveikkaus",
  storageBucket: "turnausveikkaus.firebasestorage.app",
  messagingSenderId: "102156409247",
  appId: "1:102156409247:web:25a4d876f8a7fdf0e5c5aa"
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const DATA_DOC = doc(db, "app", "data");
const PINS_DOC = doc(db, "app", "pins");

// =====================
// VAKIOT
// =====================
const PLAYERS = ["Roosa","Timo","Tero","Tiina","Tepa","√Ñiti","Isk√§"];
const ADMIN = "Tero";

const PENALTY_REASONS = ['Koukkaaminen','Mailasta kiinnipit√§minen','Est√§minen','P√§√§h√§n kohdistuva taklaus','Huitominen','V√§kivaltaisuus','Rynt√§ys','Tappelu','Liian monta pelaajaa j√§√§ll√§','Poikittainen maila','Kampitus','Kiinnipit√§minen','Mailan tai esineen heitt√§minen','Laitataklaus','Sukeltaminen','Kyyn√§rp√§√§taklaus','Pelin viivytt√§minen','Kiekon sulkeminen','Korkea maila','Sel√§st√§ taklaaminen','K√§yt√∂srangaistus','P√§√§ll√§ iskeminen','Polvitaklaus','Mailan p√§√§ll√§ ly√∂minen tai sen yritys','Keih√§st√§minen','Jalkapyyhk√§isy','Rikkoutuneella mailalla pelaaminen','V√§√§r√§ varuste','Pelaajaa ei ole merkitty p√∂yt√§kirjaan','Potkaisee tai sylkee','Ei j√§√§hy√§'];
const GOAL_SCORERS = ['Juuse Saros (MV)','Joonas Korpisalo (MV)','Kevin Lankinen (MV)','Miro Heiskanen (P)','Esa Lindell (P)','Niko Mikkola (P)','Henri Jokiharju (P)','Rasmus Ristolainen (P)','Nikolas Matinpalo (P)','Olli M√§√§tt√§ (P)','Mikko Lehtonen (P)','Mikael Granlund (H)','Roope Hintz (H)','Mikko Rantanen (H)','Teuvo Ter√§v√§inen (H)','Sebastian Aho (H)','Artturi Lehkonen (H)','Eetu Luostarinen (H)','Anton Lundell (H)','Kaapo Kakko (H)','Eeli Tolvanen (H)','Erik Haula (H)','Joel Armia (H)','Oliver Kapanen (H)','Joel Kiviranta (H)','Ei maalia'];
const PENALTY_TAKERS = [...GOAL_SCORERS.slice(0,-1),'Ei j√§√§hy√§','Joukkue rangaistus'];
const FIELDS = [
  {key:'lopputulos',label:'Lopputulos'},{key:'ekan_maalintekija',label:'Ekan maalintekij√§'},
  {key:'ekan_maali_aika',label:'Ekan maalin tekoaika'},{key:'ekan_jahyn_saaja',label:'Ekan j√§√§hyn saaja'},
  {key:'ekan_jahyn_syy',label:'Ekan j√§√§hyn syy'},{key:'montako_jahyja',label:'Montako j√§√§hyd√§'},
  {key:'parempi_laukasu',label:'Kummalla parempi laukaus%'},{key:'parempi_alotus',label:'Kummalla parempi aloitus%'},
  {key:'parempi_torjunta',label:'Kummalla parempi torjunta%'},{key:'parempi_alivoima',label:'Kummalla parempi alivoima%'},
  {key:'parempi_ylivoima',label:'Kummalla parempi ylivoima%'},{key:'era1',label:'1. er√§ tulos'},
  {key:'era2',label:'2. er√§ tulos'},{key:'valmentaja_haasto',label:'Valmentaja haasto'},{key:'maali_tyhjiin',label:'Maali tyhjiin'}
];
const ONE_X_TWO = new Set(['parempi_laukasu','parempi_alotus','parempi_torjunta','parempi_alivoima','parempi_ylivoima','era1','era2']);
const KYLLA_EI = new Set(['valmentaja_haasto','maali_tyhjiin']);
const NUMBER_K = new Set(['montako_jahyja']);

// =====================
// TILA
// =====================
let data = {tournaments:[]};
let selectedTournamentId = null;
let selectedMatchId = null;
let viewMode = 'cards';
let currentUser = null;
let isSaving = false;
let saveQueued = false;
let cdInterval = null;
let pins = {}; // { "Roosa": "1234", ... } ‚Äì ladataan Firestoresta

// =====================
// HELPERS
// =====================
const $ = id => document.getElementById(id);
function ciEq(a,b){ return (a||'').trim().toLowerCase()===(b||'').trim().toLowerCase(); }
function getTournament(){ return (data.tournaments||[]).find(t=>String(t.id)===String(selectedTournamentId)); }
function getMatch(){ const t=getTournament(); return t?(t.matches||[]).find(m=>String(m.id)===String(selectedMatchId)):null; }
function isLocked(match){ return match&&match.startTime&&Date.now()>=new Date(match.startTime).getTime(); }
function timeMatch(p,a){ const parse=s=>{const m=(s||'').match(/^(\d{1,2}):(\d{2})$/);return m?+m[1]*60+ +m[2]:null;}; const ps=parse(p),as=parse(a); return ps!=null&&as!=null&&Math.abs(ps-as)<=60; }
function fieldMatch(key,pv,av){ if(!av||!pv) return false; if(key==='ekan_maali_aika') return timeMatch(pv,av); return ciEq(pv,av); }
function calcMatchPts(t,mid,player){ const pr=(t.predictions[mid]||{})[player]||{},ac=t.actuals[mid]||{}; let s=0; FIELDS.forEach(f=>{if(ac[f.key]!=null&&ac[f.key]!==''&&fieldMatch(f.key,pr[f.key]||'',ac[f.key]))s++;}); return s; }
function calcTotals(t){ const tot={}; PLAYERS.forEach(p=>tot[p]=0); (t.matches||[]).forEach(m=>PLAYERS.forEach(p=>{tot[p]+=calcMatchPts(t,m.id,p);})); if(t.topThreePrediction){const aT=t.actualTopThree||[];PLAYERS.forEach(p=>{const pr=t.topThreePrediction[p]||[];if(pr.length===3){let pts=0;pr.forEach((team,i)=>{if(team&&aT[i]&&ciEq(team,aT[i]))pts+=2;});tot[p]+=pts;}});} return tot; }

// =====================
// STATUS BAR
// =====================
function showStatus(msg,color){ const el=$('fb-status'); el.textContent=msg; el.style.background=color||'#f97316'; el.style.color='#fff'; el.style.opacity='1'; }
function hideStatus(){ setTimeout(()=>{ $('fb-status').style.opacity='0'; },1800); }

// =====================
// FIREBASE
// =====================
async function save(){
  data.selectedTournamentId=selectedTournamentId;
  try{ localStorage.setItem('tv_bkp',JSON.stringify(data)); }catch(e){}
  if(isSaving){ saveQueued=true; return; }
  isSaving=true; showStatus('üíæ Tallennetaan‚Ä¶','#f97316');
  try{ await setDoc(DATA_DOC,{json:JSON.stringify(data)}); showStatus('‚úÖ Tallennettu','#22c55e'); hideStatus(); }
  catch(e){ showStatus('‚ùå Tallennus ep√§onnistui','#dc2626'); }
  isSaving=false; if(saveQueued){ saveQueued=false; save(); }
}

async function loadData(){
  showStatus('‚è≥ Ladataan‚Ä¶','#6366f1');
  try{
    const [snap, pinSnap] = await Promise.all([getDoc(DATA_DOC), getDoc(PINS_DOC)]);
    if(snap.exists()){ data=JSON.parse(snap.data().json); selectedTournamentId=data.selectedTournamentId||null; }
    if(pinSnap.exists()){ pins=pinSnap.data().pins||{}; }
  }catch(e){
    const bkp=localStorage.getItem('tv_bkp');
    if(bkp) try{data=JSON.parse(bkp);selectedTournamentId=data.selectedTournamentId||null;}catch(e2){}
    showStatus('‚ö†Ô∏è Yhteysvirhe ‚Äì paikallinen data','#f59e0b');
  }
  if(!data.tournaments) data.tournaments=[];
  hideStatus(); renderAll();
  onSnapshot(DATA_DOC,snap=>{
    if(!snap.exists()||isSaving) return;
    try{
      const remote=JSON.parse(snap.data().json);
      data=remote; if(!data.tournaments) data.tournaments=[];
      if(selectedTournamentId&&!data.tournaments.find(t=>String(t.id)===String(selectedTournamentId))) selectedTournamentId=data.selectedTournamentId||null;
      renderAll();
    }catch(e){}
  });
}

// =====================
// KIRJAUTUMINEN + PIN
// =====================
let pinBuffer = '';
let pendingLoginName = '';

function buildLogin(){
  $('playerGrid').innerHTML=PLAYERS.map(p=>`<button class="player-btn ${p===ADMIN?'admin':''}" onclick="window._selectName('${p}')">${p===ADMIN?'üëë ':''}${p}</button>`).join('');
}

window._selectName = function(name){
  pendingLoginName = name;
  pinBuffer = '';
  $('loginStep1').style.display='none';
  $('loginStep2').style.display='';
  $('loginName').textContent = name;
  $('pinError').textContent = '';
  renderPinDots();
};

window._backToNames = function(){
  pendingLoginName=''; pinBuffer='';
  $('loginStep1').style.display='';
  $('loginStep2').style.display='none';
};

function renderPinDots(){
  $('pinDots').innerHTML = [0,1,2,3].map(i=>
    `<div class="pin-dot ${i<pinBuffer.length?'filled':''}"></div>`
  ).join('');
}

function handlePinKey(v){
  if(v==='clear'){ pinBuffer=''; renderPinDots(); $('pinError').textContent=''; return; }
  if(v==='back'){ pinBuffer=pinBuffer.slice(0,-1); renderPinDots(); $('pinError').textContent=''; return; }
  if(pinBuffer.length>=4) return;
  pinBuffer+=v;
  renderPinDots();
  if(pinBuffer.length===4) checkPin();
}

async function checkPin(){
  const name=pendingLoginName;
  // Lataa tuoreet PINit Firestoresta
  try{
    const snap=await getDoc(PINS_DOC);
    if(snap.exists()) pins=snap.data().pins||{};
  }catch(e){}

  const storedPin=pins[name];
  if(!storedPin){
    // Ei PINi√§ asetettu ‚Äì admin voi sis√§√§n, muut eiv√§t
    if(name===ADMIN){
      doLogin(name);
    } else {
      $('pinError').textContent='PIN-koodia ei ole asetettu. Pyyd√§ adminia asettamaan PIN.';
      pinBuffer=''; renderPinDots();
    }
    return;
  }
  if(pinBuffer===storedPin){
    doLogin(name);
  } else {
    $('pinError').textContent='V√§√§r√§ PIN-koodi. Yrit√§ uudelleen.';
    pinBuffer=''; renderPinDots();
  }
}

function doLogin(name){
  currentUser=name;
  localStorage.setItem('tv_user',name);
  $('loginScreen').style.display='none';
  $('appScreen').style.display='';
  $('currentUserBadge').textContent=(name===ADMIN?'üëë ':'')+name;
  const isAdmin=name===ADMIN;
  $('adminTournamentTools').style.display=isAdmin?'':'none';
  $('adminMatchTools').style.display=isAdmin?'':'none';
  $('adminStatusCard').style.display=isAdmin?'':'none';
  $('adminPinTools').style.display=isAdmin?'':'none';
  $('importBtn').style.display=isAdmin?'':'none';
  $('viewTabs').style.display=isAdmin?'':'none';
  loadData();
}

window._logout = function(){
  currentUser=null; localStorage.removeItem('tv_user');
  pinBuffer=''; pendingLoginName='';
  $('loginScreen').style.display=''; $('appScreen').style.display='none';
  $('loginStep1').style.display=''; $('loginStep2').style.display='none';
  if(cdInterval) clearInterval(cdInterval);
};

// PIN nappi-handler
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('.pin-key').forEach(btn=>{
    btn.addEventListener('click',()=>handlePinKey(btn.dataset.v));
  });
});

// =====================
// WIDGET
// =====================
function widget(kind,key,value,dataset,disabled){
  const ds=kind==='pred'?`data-pred="${dataset}"`:`data-act="${key}"`;
  const dis=disabled?'disabled':'';
  if(key==='lopputulos'){
    const p=(value||'').split('-'),h=p[0]?p[0].trim():'',a=p[1]?p[1].trim():'';
    const ha=kind==='pred'?`data-pred-home="${dataset}"`:'data-act-home';
    const aa=kind==='pred'?`data-pred-away="${dataset}"`:'data-act-away';
    return `<div class="score-combo"><input type="number" inputmode="numeric" ${ha} value="${h}" placeholder="0" ${dis}/><span class="dash">-</span><input type="number" inputmode="numeric" ${aa} value="${a}" placeholder="0" ${dis}/></div>`;
  }
  if(key==='ekan_maali_aika'){
    const p=(value||'').split(':'),m=p[0]?p[0].trim():'',s=p[1]?p[1].trim():'';
    const ma=kind==='pred'?`data-pred-min="${dataset}"`:'data-act-min';
    const sa=kind==='pred'?`data-pred-sec="${dataset}"`:'data-act-sec';
    return `<div class="time-combo"><input type="number" inputmode="numeric" ${ma} value="${m}" placeholder="00" ${dis}/><span class="colon">:</span><input type="number" inputmode="numeric" ${sa} value="${s}" placeholder="00" ${dis}/></div>`;
  }
  const makeSelect=(opts)=>`<select ${ds} ${dis}>${opts.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o||'‚Äî'}</option>`).join('')}</select>`;
  if(key==='ekan_maalintekija') return makeSelect(['', ...GOAL_SCORERS]);
  if(key==='ekan_jahyn_saaja') return makeSelect(['', ...PENALTY_TAKERS]);
  if(key==='ekan_jahyn_syy') return makeSelect(['', ...PENALTY_REASONS]);
  if(ONE_X_TWO.has(key)) return makeSelect(['','1','X','2']);
  if(KYLLA_EI.has(key)) return makeSelect(['','Kyll√§','Ei']);
  if(NUMBER_K.has(key)) return `<input type="number" inputmode="numeric" ${ds} value="${value||''}" placeholder="0" ${dis}/>`;
  return `<input type="text" ${ds} value="${value||''}" placeholder="‚Ä¶" ${dis}/>`;
}

// =====================
// PRED LISTENERS
// =====================
function attachPredListeners(el,t,matchId){
  function handlePred(e){
    if(e.target.dataset.predHome!=null||e.target.dataset.predAway!=null){
      const par=e.target.closest('.score-combo'); if(!par) return;
      const hi=par.querySelector('[data-pred-home]'),ai=par.querySelector('[data-pred-away]');
      if(!hi||!hi.dataset.predHome) return;
      const [pl]=hi.dataset.predHome.split(':');
      t.predictions[matchId]=t.predictions[matchId]||{}; t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
      t.predictions[matchId][pl]['lopputulos']=hi.value&&ai.value?`${hi.value}-${ai.value}`:''; return;
    }
    if(e.target.dataset.predMin!=null||e.target.dataset.predSec!=null){
      const par=e.target.closest('.time-combo'); if(!par) return;
      const mi=par.querySelector('[data-pred-min]'),si=par.querySelector('[data-pred-sec]');
      if(!mi||!mi.dataset.predMin) return;
      const [pl]=mi.dataset.predMin.split(':');
      t.predictions[matchId]=t.predictions[matchId]||{}; t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
      t.predictions[matchId][pl]['ekan_maali_aika']=mi.value&&si.value?`${mi.value}:${si.value}`:''; return;
    }
    const ds=e.target.dataset.pred; if(!ds) return;
    const [pl,key]=ds.split(':');
    t.predictions[matchId]=t.predictions[matchId]||{}; t.predictions[matchId][pl]=t.predictions[matchId][pl]||{};
    t.predictions[matchId][pl][key]=e.target.value;
  }
  // Numerokenttiin 'input', valintoihin 'change' (tallennetaan heti)
  el.querySelectorAll('input[data-pred],input[data-pred-home],input[data-pred-away],input[data-pred-min],input[data-pred-sec]').forEach(inp=>{
    inp.addEventListener('input', handlePred);
    inp.addEventListener('blur',()=>{ save(); renderScoreboard(); });
  });
  el.querySelectorAll('select[data-pred]').forEach(sel=>{
    sel.addEventListener('change', handlePred);
    sel.addEventListener('change',()=>{ save(); renderScoreboard(); });
  });
}

// =====================
// HIGHLIGHT
// =====================
function doHighlight(player,key){
  const t=getTournament(); if(!t||!selectedMatchId) return;
  const av=(t.actuals[selectedMatchId]||{})[key]||'';
  const pv=(t.predictions[selectedMatchId]||{})[player]?.[key]||'';
  const eq=av!==''&&fieldMatch(key,pv,av), neq=av!==''&&pv!==''&&!eq;
  const row=document.querySelector(`[data-card-row="${player}:${key}"]`);
  if(row){ row.classList.toggle('correct',eq); row.classList.toggle('incorrect',neq); }
}
function refreshAllHL(){ FIELDS.forEach(f=>PLAYERS.forEach(p=>doHighlight(p,f.key))); }

// =====================
// RENDER: KIRJAUTUMINEN
// =====================
buildLogin();
const savedUser=localStorage.getItem('tv_user');
if(savedUser&&PLAYERS.includes(savedUser)){
  // Auto-login: luota tallennettua sessiota (PIN on jo tarkistettu aiemmin)
  doLogin(savedUser);
}

// =====================
// RENDER: TURNAUSVALINTA
// =====================
function renderTournamentSelect(){
  const sel=$('tournamentSelect');
  sel.innerHTML=['<option value="">Valitse turnaus‚Ä¶</option>'].concat(
    (data.tournaments||[]).map(t=>`<option value="${t.id}" ${String(t.id)===String(selectedTournamentId)?'selected':''}>${t.name}${t.finished?' ‚úÖ':''}</option>`)
  ).join('');
  sel.onchange=e=>{ selectedTournamentId=e.target.value||null; selectedMatchId=null; save(); renderAll(); };
}

// =====================
// RENDER: OTTELUVALINTA
// =====================
function renderMatchSelect(){
  const sel=$('matchSelect'),t=getTournament();
  if(!t){ sel.innerHTML='<option value="">‚Äî</option>'; sel.disabled=true; return; }
  sel.disabled=false;
  sel.innerHTML=['<option value="">Valitse ottelu‚Ä¶</option>'].concat(
    (t.matches||[]).map(m=>{
      const lk=isLocked(m)?'üîí ':'';
      const ts=m.startTime?' ('+new Date(m.startTime).toLocaleString('fi-FI',{day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'})+')':'';
      return `<option value="${m.id}" ${String(m.id)===String(selectedMatchId)?'selected':''}>${lk}${m.name}${ts}</option>`;
    })
  ).join('');
  sel.onchange=e=>{ selectedMatchId=e.target.value||null; updateDeleteMatchBtn(); renderMatchView(); };
  updateDeleteMatchBtn();
}

// =====================
// RENDER: SCOREBOARD
// =====================
function renderScoreboard(){
  const el=$('scoreboard');
  if(!selectedTournamentId){ el.innerHTML='<p class="muted">Valitse turnaus.</p>'; return; }
  const t=getTournament(), totals=calcTotals(t), sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const uPts=[...new Set(sorted.map(x=>x[1]))].sort((a,b)=>b-a);
  const icon=pts=>{ const r=uPts.indexOf(pts)+1; return r===1?'ü•á':r===2?'ü•à':r===3?'ü•â':'üí©'; };
  el.innerHTML='<div class="score-grid">'+sorted.map(([n,pts])=>`<div class="score-card"><div class="name">${icon(pts)} ${n}</div><div class="pts">${pts} p</div></div>`).join('')+'</div>';
}

// =====================
// RENDER: KOLMEN K√ÑRKI
// =====================
// Kolmen k√§rki lukittuu kun ensimm√§inen ottelu alkaa
function isTop3Locked(t){
  if(!t||!(t.matches||[]).length) return false;
  const first=[...t.matches].sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0))[0];
  return isLocked(first);
}

function renderTopThree(){
  const wrap=$('topThreeArea'),t=getTournament();
  if(!t){ wrap.innerHTML='<p class="muted">Luo ensin turnaus.</p>'; return; }
  t.topThreePrediction=t.topThreePrediction||{}; t.actualTopThree=t.actualTopThree||['','',''];
  const TEAMS=['KANADA','SUOMI','USA','RUOTSI','TSEKKI','RANSKA','SVEITSI','ITALIA','SLOVAKIA','TANSKA','SAKSA','LATVIA','NORJA','ISO-BRITANNIA','KAZAKSTAN','IT√ÑVALTA','SLOVENIA','PUOLA','UKRAINA','VIRO','LIETTUA'];
  const tOpts='<option value=""></option>'+TEAMS.map(tm=>`<option value="${tm}">${tm}</option>`).join('');
  const isAdmin=currentUser===ADMIN;
  const uPred=t.topThreePrediction[currentUser]||['','',''];
  const aT3=t.actualTopThree||[];
  const locked=isTop3Locked(t);           // Lukittu kun 1. peli alkaa
  const showResults=t.finished;           // Tulokset ja faktat-kentt√§ vasta turnauksen j√§lkeen
  const hasVoted=uPred.some(v=>v!=='');

  // Status-banneri
  let banner='';
  if(!t.matches||!t.matches.length){
    banner=`<p class="muted" style="margin-bottom:8px">Veikkaus avautuu kun ensimm√§inen ottelu luodaan.</p>`;
  } else if(locked&&!showResults){
    banner=`<div class="lock-banner" style="margin-bottom:8px">üîí Kolmen k√§rki lukittu ‚Äì tulokset n√§kyv√§t turnauksen j√§lkeen</div>`;
  } else if(!locked){
    const first=[...t.matches].sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0))[0];
    const ts=first.startTime?new Date(first.startTime).toLocaleString('fi-FI',{weekday:'short',day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'}):'';
    banner=`<div class="open-banner" style="margin-bottom:8px">‚úÖ Veikkaukset auki${ts?' ‚Äì lukittuu '+ts:''}</div>`;
  }

  // Admin: n√§yt√§ kuka on veikannut (ei sis√§lt√∂√§ ennen turnauksen p√§√§ttymist√§)
  let adminStatus='';
  if(isAdmin){
    adminStatus=`<div style="margin-bottom:10px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">üë• Kuka on veikannut kolmen k√§rjen?</div><div class="player-status-grid">`+
    PLAYERS.map(p=>{
      const pv=t.topThreePrediction[p]||[];
      const voted=pv.some(v=>v!=='');
      const cls=showResults?'done':voted?'voted':'not-voted';
      const icon=voted?'‚úÖ':'‚ùå';
      return `<div class="player-status-card ${cls}">${icon} ${p}</div>`;
    }).join('')+`</div></div>`;
  }

  let html=banner+adminStatus+'<div class="t3-grid">';

  // Admin: faktat-kentt√§ heti kun turnaus on lukittu
  if(isAdmin&&locked){
    html+=`<div class="t3-card"><div class="t3-title">‚úÖ Lis√§√§ todellinen j√§rjestys</div>${[0,1,2].map(i=>`<div class="t3-row"><label style="font-size:12px;color:var(--muted);margin-bottom:2px">${i+1}. sija</label><select data-t3a="${i}">${tOpts}</select></div>`).join('')}</div>`;
  }

  // Oma veikkaus ‚Äì piilotettu jos ei ole luotu otteluita viel√§
  if(t.matches&&t.matches.length){
    const dis=locked?'disabled':'';
    if(showResults){
      // N√§yt√§ oma veikkaus tuloksineen
      html+=`<div class="t3-card"><div class="t3-title">Oma veikkaus</div>${[0,1,2].map(i=>`<div class="t3-row"><label style="font-size:12px;color:var(--muted);margin-bottom:2px">${i+1}. sija</label><select data-t3m="${i}" ${dis}>${tOpts}</select></div>`).join('')}</div>`;
    } else if(locked){
      // Lukittu: n√§yt√§ oma veikkaus lukittuna ilman tuloksia
      html+=`<div class="t3-card"><div class="t3-title">Oma veikkaus üîí</div><p class="muted" style="font-size:13px">Veikkauksesi on tallennettu. Tulokset n√§kyv√§t turnauksen j√§lkeen.</p></div>`;
    } else {
      // Auki: veikkaa
      html+=`<div class="t3-card"><div class="t3-title">Oma veikkaus</div>${[0,1,2].map(i=>`<div class="t3-row"><label style="font-size:12px;color:var(--muted);margin-bottom:2px">${i+1}. sija</label><select data-t3m="${i}">${tOpts}</select></div>`).join('')}</div>`;
    }
  }

  html+='</div>';
  wrap.innerHTML=html;

  // Aseta arvot
  if(isAdmin&&locked) [0,1,2].forEach(i=>{ const s=wrap.querySelector(`[data-t3a="${i}"]`); if(s&&aT3[i]) s.value=aT3[i]; });
  if(showResults||!locked) [0,1,2].forEach(i=>{ const s=wrap.querySelector(`[data-t3m="${i}"]`); if(s&&uPred[i]) s.value=uPred[i]; });

  const markT3=()=>{
    if(!showResults) return; // Ei v√§rej√§ ennen turnauksen p√§√§ttymist√§
    const act=(t.actualTopThree||[]).map(x=>(x||'').toLowerCase());
    wrap.querySelectorAll('[data-t3m]').forEach(inp=>{
      inp.classList.remove('correct','incorrect');
      const v=(inp.value||'').toLowerCase(),idx=+inp.dataset.t3m,ac=act[idx]||'';
      if(ac){ if(v&&v===ac)inp.classList.add('correct'); else if(v)inp.classList.add('incorrect'); }
    });
  };
  markT3();

  if(!locked) wrap.querySelectorAll('[data-t3m]').forEach(inp=>inp.addEventListener('change',e=>{
    const idx=+e.target.dataset.t3m;
    t.topThreePrediction[currentUser]=t.topThreePrediction[currentUser]||['','',''];
    t.topThreePrediction[currentUser][idx]=e.target.value;
    markT3(); renderScoreboard(); save();
  }));
  if(isAdmin&&locked) wrap.querySelectorAll('[data-t3a]').forEach(inp=>inp.addEventListener('change',e=>{
    t.actualTopThree[+e.target.dataset.t3a]=e.target.value;
    markT3(); renderScoreboard(); save();
  }));
}

// =====================
// RENDER: ADMIN STATUS
// =====================
function renderPlayerStatus(){
  const el=$('playerStatusArea'),t=getTournament(),match=getMatch();
  if(!t||!match||currentUser!==ADMIN){ el.innerHTML=''; return; }
  const preds=t.predictions[match.id]||{};
  const locked=isLocked(match);
  el.innerHTML='<div class="player-status-grid">'+PLAYERS.map(p=>{
    const voted=preds[p]&&Object.values(preds[p]).some(v=>v!=='');
    const cls=locked?'done':voted?'voted':'not-voted';
    const icon=locked?'‚úÖ':voted?'‚úÖ':'‚ùå';
    return `<div class="player-status-card ${cls}">${icon} ${p}</div>`;
  }).join('')+'</div>';
}

// =====================
// RENDER: COUNTDOWN
// =====================
function startCountdown(match){
  if(cdInterval) clearInterval(cdInterval);
  const el=$('countdown');
  if(!match||!match.startTime){ el.textContent=''; return; }
  const update=()=>{
    const diff=new Date(match.startTime).getTime()-Date.now();
    if(diff<=0){ el.textContent=''; clearInterval(cdInterval); renderAll(); return; }
    const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
    el.textContent=`‚è≥ Veikkauksia voi muuttaa viel√§: ${h>0?h+'t ':''} ${m}min ${s}s`;
  };
  update(); cdInterval=setInterval(update,1000);
}

// =====================
// RENDER: VEIKKAUKSET
// =====================
function renderPredCard(t,match,player,showResults){
  const pred=(t.predictions[match.id]||{})[player]||{};
  const actual=t.actuals[match.id]||{};
  const locked=isLocked(match);
  const canEdit=(player===currentUser&&!locked)||(currentUser===ADMIN&&showResults);
  const pts=calcMatchPts(t,match.id,player);
  const rows=FIELDS.map(f=>{
    const v=pred[f.key]||'',av=actual[f.key]||'';
    const correct=showResults&&av!==''&&fieldMatch(f.key,v,av);
    const incorrect=showResults&&av!==''&&v!==''&&!correct;
    const w=widget('pred',f.key,v,`${player}:${f.key}`,!canEdit);
    return `<div class="kv-row ${correct?'correct':''} ${incorrect?'incorrect':''}" data-card-row="${player}:${f.key}"><div class="kv-label">${f.label}</div>${w}</div>`;
  }).join('');
  return `<div class="person-card"><div class="card-head"><div class="person-title">${player===ADMIN?'üëë ':''} ${player}</div>${showResults?`<div class="pts-badge">${pts} p</div>`:''}</div><div class="kv">${rows}</div></div>`;
}

function renderMatchView(){
  const t=getTournament(),match=getMatch();
  const banEl=$('matchLockBanner'),cdEl=$('countdown'),predEl=$('predictionsArea');
  if(!match){ banEl.innerHTML=''; cdEl.textContent=''; predEl.innerHTML='<p class="muted">Valitse ottelu.</p>'; renderActuals(); renderPlayerStatus(); return; }

  const locked=isLocked(match);
  const showResults=locked; // Tulokset n√§kyy kun peli alkaa

  // Banneri
  if(locked){
    banEl.innerHTML=`<div class="lock-banner">üîí Peli alkanut ‚Äì veikkaukset lukittu ‚Äì tulokset n√§kyviss√§</div>`;
  } else {
    const ts=match.startTime?new Date(match.startTime).toLocaleString('fi-FI',{weekday:'short',day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'}):'';
    banEl.innerHTML=`<div class="open-banner">‚úÖ Veikkaukset auki${ts?' ‚Äì lukittuu '+ts:''}</div>`;
  }

  startCountdown(match);
  renderPlayerStatus();

  if(currentUser===ADMIN){
    if(!locked){
      // Ennen pelin alkua: admin n√§kee VAIN omat veikkauksensa
      predEl.innerHTML=renderPredCard(t,match,ADMIN,false);
      attachPredListeners(predEl,t,match.id);
    } else if(viewMode==='table'){
      // Pelin j√§lkeen taulukko
      const actual=t.actuals[match.id]||{};
      let thead=`<tr><th class="sticky-top sticky-left sticky-corner">Kohde</th>${PLAYERS.map(p=>`<th class="sticky-top">${p===ADMIN?'üëë':''} ${p}</th>`).join('')}</tr>`;
      let tbody=FIELDS.map(f=>{
        let row=`<tr><th class="sticky-left">${f.label}</th>`;
        row+=PLAYERS.map(p=>{
          const pv=(t.predictions[match.id]||{})[p]?.[f.key]||'';
          const av=actual[f.key]||'';
          const correct=av!==''&&fieldMatch(f.key,pv,av);
          const incorrect=av!==''&&pv!==''&&!correct;
          const w=widget('pred',f.key,pv,`${p}:${f.key}`,true);
          return `<td class="${correct?'correct':''} ${incorrect?'incorrect':''}">${w}</td>`;
        }).join('');
        return row+'</tr>';
      }).join('');
      predEl.innerHTML=`<div class="table-wrap"><table><thead>${thead}</thead><tbody>${tbody}</tbody></table></div>`;
      attachPredListeners(predEl,t,match.id);
    } else {
      // Pelin j√§lkeen kortit: admin n√§kee kaikki
      predEl.innerHTML=PLAYERS.map(p=>renderPredCard(t,match,p,true)).join('');
      attachPredListeners(predEl,t,match.id);
    }
  } else {
    // Veikkaaja: n√§kee vain oman kortin
    if(showResults){
      // Pelin j√§lkeen: oma kortti + scoreboard n√§kyviss√§
      predEl.innerHTML=renderPredCard(t,match,currentUser,true);
    } else {
      predEl.innerHTML=renderPredCard(t,match,currentUser,false);
    }
    attachPredListeners(predEl,t,match.id);
  }

  renderActuals();
}

// =====================
// RENDER: FAKTAT
// =====================
function renderActuals(){
  const el=$('actualsArea'),t=getTournament();
  if(!t||!selectedMatchId){ el.innerHTML='<p class="muted">Valitse ottelu.</p>'; return; }
  t.actuals[selectedMatchId]=t.actuals[selectedMatchId]||{};
  const act=t.actuals[selectedMatchId];
  const isAdmin=currentUser===ADMIN;
  const rows=FIELDS.map(f=>`<div class="kv-row"><div class="kv-label">${f.label}</div>${widget('act',f.key,act[f.key]||'',f.key,!isAdmin)}</div>`).join('');
  el.innerHTML=`<div class="person-card actuals-card"><div class="card-head"><div class="person-title">Faktat</div><div class="pill">${isAdmin?'Muokattavissa':'Vain luku'}</div></div><div class="kv">${rows}</div></div>`;
  if(!isAdmin) return;
  function handleActualChange(e){
    if(e.target.dataset.actHome!=null||e.target.dataset.actAway!=null){
      const par=e.target.closest('.score-combo'); if(!par) return;
      const hi=par.querySelector('[data-act-home]'),ai=par.querySelector('[data-act-away]');
      t.actuals[selectedMatchId]['lopputulos']=hi.value&&ai.value?`${hi.value}-${ai.value}`:''; renderScoreboard(); save(); return;
    }
    if(e.target.dataset.actMin!=null||e.target.dataset.actSec!=null){
      const par=e.target.closest('.time-combo'); if(!par) return;
      const mi=par.querySelector('[data-act-min]'),si=par.querySelector('[data-act-sec]');
      t.actuals[selectedMatchId]['ekan_maali_aika']=mi.value&&si.value?`${mi.value}:${si.value}`:''; renderScoreboard(); save(); return;
    }
    const key=e.target.dataset.act; if(!key) return;
    t.actuals[selectedMatchId][key]=e.target.value; renderScoreboard(); save();
  }
  el.querySelectorAll('input[data-act],input[data-act-home],input[data-act-away],input[data-act-min],input[data-act-sec]').forEach(inp=>{
    inp.addEventListener('input', handleActualChange);
  });
  el.querySelectorAll('select[data-act]').forEach(sel=>{
    sel.addEventListener('change', handleActualChange);
  });
}

// =====================
// RENDER: TURNAUKSEN STATUS
// =====================
function renderTournamentStatus(){
  const t=getTournament();
  const fa=$('finishTournamentArea'),badge=$('tournamentFinishedBadge'),del=$('deleteTournamentArea');
  if(!t||currentUser!==ADMIN){ if(fa)fa.style.display='none'; if(badge)badge.style.display='none'; if(del)del.style.display='none'; $('statsCard').style.display='none'; return; }
  if(del) del.style.display=''; // Poista-nappi aina n√§kyviss√§ adminille kun turnaus valittu
  if(t.finished){ if(fa)fa.style.display='none'; if(badge)badge.style.display=''; renderStats(); }
  else { if(fa)fa.style.display=''; if(badge)badge.style.display='none'; $('statsCard').style.display='none'; }
}

// =====================
// RENDER: STATS
// =====================
function renderStats(){
  const t=getTournament(); if(!t) return;
  $('statsCard').style.display='';
  const el=$('statsArea');
  const totals=calcTotals(t),sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const medals=['ü•á','ü•à','ü•â'];
  let best=null;
  (t.matches||[]).forEach(m=>PLAYERS.forEach(p=>{ const pts=calcMatchPts(t,m.id,p); if(!best||pts>best.pts) best={player:p,matchName:m.name,pts}; }));
  const mW=(t.matches||[]).map(m=>{ let b=null; PLAYERS.forEach(p=>{ const pts=calcMatchPts(t,m.id,p); if(!b||pts>b.pts) b={player:p,pts}; else if(pts===b.pts) b.player+=' & '+p; }); return{matchName:m.name,...b}; });
  let html=`<div style="margin-bottom:14px"><div style="font-weight:700;margin-bottom:8px">ü•á Lopputulokset</div><div class="score-grid">${sorted.map(([n,pts],i)=>`<div class="score-card"><div class="name">${medals[i]||''} ${n}</div><div class="pts">${pts} p</div></div>`).join('')}</div></div><div class="separator"></div>`;
  if(best) html+=`<div style="margin-bottom:14px"><div style="font-weight:700;margin-bottom:6px">‚≠ê Paras suoritus</div><div style="background:var(--card);border:2px solid var(--primary);border-radius:10px;padding:10px"><div style="font-size:18px;font-weight:800">${best.player}</div><div style="color:var(--muted);font-size:14px">${best.matchName}</div><div style="font-size:24px;font-weight:800;color:var(--primary)">${best.pts} p</div></div></div><div class="separator"></div>`;
  html+=`<div><div style="font-weight:700;margin-bottom:8px">üèÖ Otteluvoittajat</div><div style="display:grid;gap:6px">${mW.map(w=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--card);border:1px solid var(--border);border-radius:8px"><div style="font-size:13px;color:var(--muted)">${w.matchName}</div><div><span style="font-weight:700">${w.player}</span> <span class="pts-badge">${w.pts} p</span></div></div>`).join('')}</div></div>`;
  el.innerHTML=html;
}

// =====================
// POISTO-NAPIT
// =====================
function updateDeleteMatchBtn(){
  const del=$('deleteMatchArea');
  if(!del) return;
  del.style.display=(currentUser===ADMIN&&selectedMatchId)?'':'none';
}

$('deleteTournament').onclick=()=>{
  const t=getTournament(); if(!t) return;
  if(!confirm(`Poistetaanko turnaus "${t.name}" ja kaikki sen ottelut?\n\nT√§t√§ ei voi peruuttaa!`)) return;
  data.tournaments=data.tournaments.filter(x=>String(x.id)!==String(selectedTournamentId));
  selectedTournamentId=null; selectedMatchId=null;
  save(); renderAll();
};

$('deleteMatch').onclick=()=>{
  const t=getTournament(); if(!t||!selectedMatchId) return;
  const match=getMatch(); if(!match) return;
  if(!confirm(`Poistetaanko ottelu "${match.name}" ja kaikki sen veikkaukset?\n\nT√§t√§ ei voi peruuttaa!`)) return;
  t.matches=t.matches.filter(m=>String(m.id)!==String(selectedMatchId));
  delete t.predictions[selectedMatchId];
  delete t.actuals[selectedMatchId];
  selectedMatchId=null;
  save(); renderAll();
};

// =====================
// RENDER: PIN HALLINTA (admin)
// =====================
function renderPinManage(){
  const el=$('pinManageArea'); if(!el) return;
  el.innerHTML=PLAYERS.map(p=>{
    const hasPin=pins[p]?'‚úÖ PIN asetettu':'‚ùå Ei PINi√§';
    const col=pins[p]?'#166534':'#991b1b';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);gap:8px">
      <div>
        <div style="font-weight:700">${p==='Tero'?'üëë ':''} ${p}</div>
        <div style="font-size:12px;color:${col}">${hasPin}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <input type="password" inputmode="numeric" maxlength="4" placeholder="1234"
          id="pin_${p}" style="width:80px;padding:8px;font-size:16px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)" />
        <button class="btn small" onclick="window._savePin('${p}')">Tallenna</button>
      </div>
    </div>`;
  }).join('');
}

window._savePin = async function(player){
  const input=$(`pin_${player}`);
  const val=(input?input.value:'').trim();
  if(!/^\d{4}$/.test(val)){ alert('PIN-koodin pit√§√§ olla 4 numeroa!'); return; }
  pins[player]=val;
  try{
    await setDoc(PINS_DOC,{pins});
    input.value='';
    renderPinManage();
    showStatus(`‚úÖ ${player}:n PIN tallennettu`,'#22c55e');
    hideStatus();
  }catch(e){ alert('Tallennus ep√§onnistui: '+e.message); }
};

// =====================
// RENDERALL
// =====================
function renderAll(){
  renderTournamentSelect(); renderMatchSelect(); renderTopThree(); renderScoreboard();
  renderMatchView(); renderTournamentStatus(); if(currentUser===ADMIN) renderPinManage();
}

// =====================
// NAPIT
// =====================
$('createTournament').onclick=()=>{
  const name=$('newTournamentName').value.trim(); if(!name){alert('Anna nimi');return;}
  const id=Date.now().toString();
  data.tournaments.push({id,name,matches:[],predictions:{},actuals:{},topThreePrediction:{},actualTopThree:[]});
  selectedTournamentId=id; save(); renderAll(); $('newTournamentName').value='';
};

$('finishTournament').onclick=()=>{
  const t=getTournament(); if(!t) return;
  if(!confirm(`P√§√§t√§ turnaus "${t.name}"?`)) return;
  t.finished=true; save(); renderAll();
};

$('createMatch').onclick=()=>{
  const t=getTournament(); if(!t){alert('Luo ensin turnaus');return;}
  const name=$('newMatchName').value.trim(); if(!name){alert('Anna ottelun nimi');return;}
  const tv=$('newMatchTime').value; if(!tv){alert('Aseta pelin alkuaika');return;}
  const id=Date.now().toString();
  t.matches.push({id,name,startTime:new Date(tv).toISOString()});
  selectedMatchId=id; save(); renderAll(); $('newMatchName').value=''; $('newMatchTime').value='';
};

$('tabTable').onclick=()=>{ viewMode='table'; $('tabTable').classList.add('active'); $('tabCards').classList.remove('active'); renderMatchView(); };
$('tabCards').onclick=()=>{ viewMode='cards'; $('tabCards').classList.add('active'); $('tabTable').classList.remove('active'); renderMatchView(); };
$('refreshCheck').onclick=()=>{ save(); renderScoreboard(); refreshAllHL(); };
$('saveTopThree').onclick=()=>save();
$('exportBtn').onclick=()=>{ const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='turnausveikkaus_data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u); };
$('importBtn').onclick=()=>$('importFile').click();
$('importFile').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async()=>{ try{const obj=JSON.parse(r.result);data=obj;selectedTournamentId=data.selectedTournamentId||null;selectedMatchId=null;await save();renderAll();alert('Tuotu!');}catch(er){alert('Virhe: '+er.message);} }; r.readAsText(f,'utf-8'); });

let t3v=localStorage.getItem('tv_top3')!=='0';
function applyT3(){ $('topThreeArea').style.display=t3v?'':'none'; $('saveTop3Row').style.display=t3v?'':'none'; $('toggleTop3').textContent=t3v?'Piilota':'N√§yt√§'; }
$('toggleTop3').onclick=()=>{ t3v=!t3v; localStorage.setItem('tv_top3',t3v?'1':'0'); applyT3(); };

let pinsVisible=localStorage.getItem('tv_pins')!=='0';
function applyPinsToggle(){
  const area=$('pinManageArea'); const btn=$('togglePins');
  if(!area||!btn) return;
  area.style.display=pinsVisible?'':'none';
  btn.textContent=pinsVisible?'Piilota':'N√§yt√§';
}
document.addEventListener('DOMContentLoaded',()=>{
  const btn=$('togglePins');
  if(btn) btn.addEventListener('click',()=>{ pinsVisible=!pinsVisible; localStorage.setItem('tv_pins',pinsVisible?'1':'0'); applyPinsToggle(); });
  applyPinsToggle();
});
applyT3();

</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.getElementById('screenshotTableBtn').addEventListener('click', async ()=>{
  try{
    const area=document.getElementById('predictionsArea');
    const target=area.querySelector('.table-wrap')||area;
    const canvas=await html2canvas(target,{scale:3,backgroundColor:null,useCORS:true,windowWidth:target.scrollWidth,windowHeight:target.scrollHeight});
    const link=document.createElement('a'); link.download='veikkaus.png'; link.href=canvas.toDataURL('image/png');
    document.body.appendChild(link); link.click(); link.remove();
  }catch(e){ alert('Kuvan luonti ep√§onnistui: '+(e&&e.message?e.message:e)); }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById('downloadPdfBtn').addEventListener('click', function(){
  if(!window.jspdf){ alert('Odota hetki ja yrit√§ uudelleen.'); return; }
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('Turnausveikkaus', 105, 30, {align:'center'});
  doc.setFontSize(11); doc.setFont('helvetica','normal');
  doc.text('Raportti ‚Äì '+new Date().toLocaleDateString('fi-FI'), 105, 40, {align:'center'});
  doc.text('T√§ysi PDF-raportti saatavilla turnauksen p√§√§tytty√§.', 105, 60, {align:'center'});
  doc.save('turnausveikkaus.pdf');
});
</script>

<script>
  if("serviceWorker" in navigator){ window.addEventListener("load",()=>navigator.serviceWorker.register("sw.js")); }
</script>
</body>
</html>
